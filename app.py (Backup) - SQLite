import os
import sqlite3
import secrets
from datetime import datetime
import pytz   # <--- add this (install via `pip install pytz`)
from flask import Flask, request, jsonify, session, send_from_directory, make_response
from werkzeug.security import generate_password_hash, check_password_hash
from functools import wraps
import base64
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC

app = Flask(__name__, static_folder='static', static_url_path='')
app.secret_key = os.environ.get('SESSION_SECRET', secrets.token_hex(32))

def get_encryption_key():
    """Get or generate stable encryption key"""
    db = get_db()
    try:
        cursor = db.execute('CREATE TABLE IF NOT EXISTS encryption_keys (id INTEGER PRIMARY KEY, key TEXT NOT NULL)')
        db.commit()
        
        key_row = db.execute('SELECT key FROM encryption_keys WHERE id = 1').fetchone()
        if key_row:
            key = key_row['key'].encode()
        else:
            key = Fernet.generate_key()
            db.execute('INSERT INTO encryption_keys (id, key) VALUES (1, ?)', (key.decode(),))
            db.commit()
        
        db.close()
        return key
    except Exception as e:
        print(f"Error getting encryption key: {e}")
        db.close()
        return Fernet.generate_key()

IST = pytz.timezone("Asia/Kolkata")

def now_ist():
    """Return current time in India (IST) as aware datetime."""
    return datetime.now(IST)

def encrypt_password(password):
    """Encrypt SMTP password"""
    f = Fernet(get_encryption_key())
    return f.encrypt(password.encode()).decode()

def decrypt_password(encrypted_password):
    """Decrypt SMTP password"""
    f = Fernet(get_encryption_key())
    return f.decrypt(encrypted_password.encode()).decode()

def send_notification_email(recipient_email, subject, message_body):
    """Send email notification using stored SMTP configuration"""
    if not recipient_email:
        return False
    
    import smtplib
    from email.mime.text import MIMEText
    from email.mime.multipart import MIMEMultipart
    
    db = get_db()
    try:
        config = db.execute('SELECT * FROM email_config ORDER BY id DESC LIMIT 1').fetchone()
        db.close()
        
        if not config or not config['email_enabled']:
            return False
        
        decrypted_password = decrypt_password(config['smtp_password'])
        
        msg = MIMEMultipart()
        msg['From'] = config['from_email']
        msg['To'] = recipient_email
        msg['Subject'] = subject
        
        html_body = f'''
        <html>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <div style="background: #0b5ed7; color: white; padding: 20px; border-radius: 8px 8px 0 0;">
                    <h2 style="margin: 0;">GTN ENGINEERING (INDIA) LIMITED</h2>
                    <p style="margin: 5px 0 0 0; font-size: 14px;">Contract Review Dashboard</p>
                </div>
                <div style="background: #f8f9fa; padding: 30px; border-radius: 0 0 8px 8px;">
                    {message_body}
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; color: #6b7280;">
                    <p style="margin: 0;"><strong>Note:</strong> This is an automated notification from the Contract Review Dashboard. Please do not reply to this email.</p>
                </div>
            </div>
        </body>
        </html>
        '''
        
        msg.attach(MIMEText(html_body, 'html'))
        
        server = smtplib.SMTP(config['smtp_host'], config['smtp_port'])
        if config['use_tls']:
            server.starttls()
        server.login(config['smtp_username'], decrypted_password)
        server.send_message(msg)
        server.quit()
        
        return True
    except Exception as e:
        print(f"Failed to send email: {e}")
        return False

DATABASE = 'contract_review.db'

def get_db():
    db = sqlite3.connect(DATABASE)
    db.row_factory = sqlite3.Row
    return db

def init_db():
    db = get_db()
    db.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            name TEXT NOT NULL,
            department TEXT NOT NULL,
            is_admin BOOLEAN NOT NULL DEFAULT 0,
            lead_form_access BOOLEAN NOT NULL DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    try:
        db.execute('SELECT lead_form_access FROM users LIMIT 1')
    except:
        db.execute('ALTER TABLE users ADD COLUMN lead_form_access BOOLEAN NOT NULL DEFAULT 0')
        db.commit()
    
    try:
        db.execute('SELECT email FROM users LIMIT 1')
    except:
        db.execute('ALTER TABLE users ADD COLUMN email TEXT')
        db.commit()
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS pos (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            customer TEXT NOT NULL,
            bid TEXT NOT NULL,
            po TEXT NOT NULL,
            cr TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS cr_forms (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            po_key TEXT UNIQUE NOT NULL,
            customer TEXT,
            bid TEXT,
            po TEXT,
            cr TEXT,
            record_no TEXT,
            record_date TEXT,
            last_modified_by TEXT,
            last_modified_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            amendment_details TEXT
        )
    ''')
    
    try:
        db.execute('SELECT record_no FROM cr_forms LIMIT 1')
    except:
        db.execute('ALTER TABLE cr_forms ADD COLUMN record_no TEXT')
        db.execute('ALTER TABLE cr_forms ADD COLUMN record_date TEXT')
        db.commit()
    
    try:
        db.execute('SELECT amendment_details FROM cr_forms LIMIT 1')
    except:
        db.execute('ALTER TABLE cr_forms ADD COLUMN amendment_details TEXT')
        db.commit()
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS cr_form_rows (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            cr_form_id INTEGER NOT NULL,
            item_no TEXT NOT NULL,
            part_number TEXT,
            part_description TEXT,
            rev TEXT,
            qty TEXT,
            cycles TEXT,
            remarks TEXT,
            FOREIGN KEY (cr_form_id) REFERENCES cr_forms(id) ON DELETE CASCADE
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS ped_forms (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            po_key TEXT UNIQUE NOT NULL,
            customer TEXT,
            bid TEXT,
            po TEXT,
            cr TEXT,
            record_no TEXT,
            record_date TEXT,
            amendment_details TEXT,
            last_modified_by TEXT,
            last_modified_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS ped_form_rows (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ped_form_id INTEGER NOT NULL,
            item_no TEXT NOT NULL,
            part_number TEXT,
            part_description TEXT,
            rev TEXT,
            qty TEXT,
            ped_cycles TEXT,
            notes TEXT,
            remarks TEXT,
            FOREIGN KEY (ped_form_id) REFERENCES ped_forms(id) ON DELETE CASCADE
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS lead_forms (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            po_key TEXT UNIQUE NOT NULL,
            customer TEXT,
            bid TEXT,
            po TEXT,
            cr TEXT,
            record_no TEXT,
            record_date TEXT,
            general_remarks TEXT,
            last_modified_by TEXT,
            last_modified_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    try:
        db.execute("ALTER TABLE lead_forms ADD COLUMN general_remarks TEXT")
    except:
        pass
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS lead_form_rows (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            lead_form_id INTEGER NOT NULL,
            item_no TEXT NOT NULL,
            part_number TEXT,
            part_description TEXT,
            rev TEXT,
            qty TEXT,
            customer_required_date TEXT,
            standard_lead_time TEXT,
            gtn_agreed_date TEXT,
            remarks TEXT,
            FOREIGN KEY (lead_form_id) REFERENCES lead_forms(id) ON DELETE CASCADE
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS cr_comments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            cr_form_id INTEGER NOT NULL,
            username TEXT NOT NULL,
            department TEXT NOT NULL,
            comment_text TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (cr_form_id) REFERENCES cr_forms(id) ON DELETE CASCADE
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS ped_comments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ped_form_id INTEGER NOT NULL,
            username TEXT NOT NULL,
            department TEXT NOT NULL,
            comment_text TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (ped_form_id) REFERENCES ped_forms(id) ON DELETE CASCADE
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS lead_comments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            lead_form_id INTEGER NOT NULL,
            username TEXT NOT NULL,
            department TEXT NOT NULL,
            comment_text TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (lead_form_id) REFERENCES lead_forms(id) ON DELETE CASCADE
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS notifications (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            recipient_user_id INTEGER NOT NULL,
            actor_user_id INTEGER,
            event_type TEXT NOT NULL,
            po_id INTEGER,
            form_type TEXT,
            form_id INTEGER,
            message TEXT NOT NULL,
            metadata TEXT,
            is_read BOOLEAN DEFAULT 0,
            email_sent BOOLEAN DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (recipient_user_id) REFERENCES users(id) ON DELETE CASCADE,
            FOREIGN KEY (actor_user_id) REFERENCES users(id) ON DELETE SET NULL
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS form_completion_states (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            form_type TEXT NOT NULL,
            form_id INTEGER NOT NULL,
            status TEXT DEFAULT 'in_progress',
            completion_snapshot TEXT,
            completed_by INTEGER,
            completed_at TIMESTAMP,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            UNIQUE(form_type, form_id),
            FOREIGN KEY (completed_by) REFERENCES users(id) ON DELETE SET NULL
        )
    ''')
    
    # --- New table: per-department completion states ---
    db.execute('''
        CREATE TABLE IF NOT EXISTS form_department_states (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            form_type TEXT NOT NULL,
            form_id INTEGER NOT NULL,
            department TEXT NOT NULL,
            status TEXT DEFAULT 'in_progress',
            completed_by INTEGER,
            completed_at TIMESTAMP,
            UNIQUE(form_type, form_id, department),
            FOREIGN KEY (completed_by) REFERENCES users(id) ON DELETE SET NULL
        )
    ''')
    
    db.execute('''
        CREATE TABLE IF NOT EXISTS email_config (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            smtp_host TEXT NOT NULL,
            smtp_port INTEGER NOT NULL,
            smtp_username TEXT NOT NULL,
            smtp_password TEXT NOT NULL,
            from_email TEXT NOT NULL,
            use_tls BOOLEAN DEFAULT 1,
            email_enabled BOOLEAN DEFAULT 0,
            updated_by TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    cursor = db.execute('SELECT COUNT(*) as count FROM users WHERE username = ?', ('admin',))
    if cursor.fetchone()['count'] == 0:
        db.execute(
            'INSERT INTO users (username, password_hash, name, department, is_admin) VALUES (?, ?, ?, ?, ?)',
            ('admin', generate_password_hash('admin'), 'IT Administrator', 'it', 1)
        )
    
    db.commit()
    db.close()

# ---------- Department order definitions ----------
# Make sure these department keys match the values stored in users.department
CR_DEPT_ORDER = [
    "engineering","manufacturing","materials","purchase",
    "special-process","welding","assembly","quality",
    "painting","customer-service","commercial"
]

PED_DEPT_ORDER = [
    "engineering","manufacturing","materials","purchase"
]

# map to which form to start when current form completes fully
NEXT_FORM_AFTER = {
    "CR": "PED",
    "PED": "LEAD",
    "LEAD": None
}

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return jsonify({'error': 'Unauthorized'}), 401
        return f(*args, **kwargs)
    return decorated_function

def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return jsonify({'error': 'Unauthorized'}), 401
        db = get_db()
        user = db.execute('SELECT is_admin FROM users WHERE id = ?', (session['user_id'],)).fetchone()
        db.close()
        if not user or not user['is_admin']:
            return jsonify({'error': 'Admin access required'}), 403
        return f(*args, **kwargs)
    return decorated_function

def create_notification_for_all_users(event_type, message, actor_user_id=None, po_id=None, form_type=None, form_id=None, exclude_user_id=None):
    """Create a notification for all users (optionally excluding one user)"""
    db = get_db()
    try:
        users = db.execute('SELECT id, email, name FROM users').fetchall()
        
        for user in users:
            if exclude_user_id and user['id'] == exclude_user_id:
                continue
            
            db.execute('''
                INSERT INTO notifications 
                (recipient_user_id, actor_user_id, event_type, po_id, form_type, form_id, message)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', (user['id'], actor_user_id, event_type, po_id, form_type, form_id, message))
        
        db.commit()
        
        for user in users:
            if exclude_user_id and user['id'] == exclude_user_id:
                continue
            
            if user['email']:
                if event_type == 'po_created':
                    subject = "New PO Created - Contract Review Dashboard"
                    email_body = f'''
                    <h3 style="color: #0b5ed7; margin-top: 0;">New Purchase Order Created</h3>
                    <p style="font-size: 16px; color: #111;">{message}</p>
                    <p style="margin-top: 20px;">Please log in to the Contract Review Dashboard to view the details and start working on the associated forms.</p>
                    <div style="margin-top: 30px;">
                        <a href="#" style="background: #0b5ed7; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">View Dashboard</a>
                    </div>
                    '''
                elif event_type == 'form_completed':
                    subject = f"{form_type} Form Completed - Contract Review Dashboard"
                    email_body = f'''
                    <h3 style="color: #22c55e; margin-top: 0;">Form Completed</h3>
                    <p style="font-size: 16px; color: #111;">{message}</p>
                    <p style="margin-top: 20px;">The {form_type} form has been completed and is now ready for review.</p>
                    <div style="margin-top: 30px;">
                        <a href="#" style="background: #22c55e; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">View Form</a>
                    </div>
                    '''
                else:
                    subject = "Notification - Contract Review Dashboard"
                    email_body = f'''
                    <h3 style="color: #0b5ed7; margin-top: 0;">New Notification</h3>
                    <p style="font-size: 16px; color: #111;">{message}</p>
                    '''
                
                send_notification_email(user['email'], subject, email_body)
        
        db.close()
        return True
    except Exception as e:
        db.close()
        print(f"Error creating notifications: {e}")
        return False

def check_form_completion(form_type, form_data):
    """Check if a form meets completion criteria
    
    CR: Headers + all rows have at least one cycle value
    PED: Headers + all rows have either pedCycles OR notes populated or remarks
    LEAD: Headers + all rows have all three date fields
    """
    import json
    
    if form_type == 'CR':
        if not all([form_data.get('customer'), form_data.get('bid'), form_data.get('po'), form_data.get('cr')]):
            return False
        if not form_data.get('recordNo') or not form_data.get('recordDate'):
            return False
        rows = form_data.get('rows', [])
        if not rows:
            return False
        for row in rows:
            cycles = row.get('cycles', [])
            if isinstance(cycles, str):
                try:
                    cycles = json.loads(cycles)
                except:
                    return False
            if not cycles or not isinstance(cycles, list):
                return False
            if not any(str(c).strip() for c in cycles if c):
                return False
        return True
    
    elif form_type == 'PED':
        if not all([form_data.get('customer'), form_data.get('bid'), form_data.get('po'), form_data.get('cr')]):
            return False
        if not form_data.get('recordNo') or not form_data.get('recordDate'):
            return False
        rows = form_data.get('rows', [])
        if not rows:
            return False
        for row in rows:
            ped_cycles = row.get('pedCycles', [])
            if isinstance(ped_cycles, str):
                try:
                    ped_cycles = json.loads(ped_cycles)
                except:
                    ped_cycles = []
            
            notes = row.get('notes', [])
            if isinstance(notes, str):
                try:
                    notes = json.loads(notes)
                except:
                    notes = []
            
            remarks = str(row.get('remarks', '')).strip()
            
            has_cycles = isinstance(ped_cycles, list) and any(str(c).strip() for c in ped_cycles if c)
            has_notes = isinstance(notes, list) and any(str(n).strip() for n in notes if n)
            has_remarks = bool(remarks)
            
            if not (has_cycles or has_notes or has_remarks):
                return False
        return True
    
    elif form_type == 'LEAD':
        if not all([form_data.get('customer'), form_data.get('bid'), form_data.get('po'), form_data.get('cr')]):
            return False
        if not form_data.get('recordNo') or not form_data.get('recordDate'):
            return False
        rows = form_data.get('rows', [])
        if not rows:
            return False
        for row in rows:
            cust_date = str(row.get('customerRequiredDate', '')).strip()
            std_lead = str(row.get('standardLeadTime', '')).strip()
            gtn_date = str(row.get('gtnAgreedDate', '')).strip()
            if not cust_date or not std_lead or not gtn_date:
                return False
        return True
    
    return False

def handle_form_completion_notification(form_type, form_id, form_data, user_id, username):
    """Check and notify if form is newly completed"""
    db = get_db()
    try:
        is_complete = check_form_completion(form_type, form_data)
        
        existing = db.execute('''
            SELECT status FROM form_completion_states 
            WHERE form_type = ? AND form_id = ?
        ''', (form_type, form_id)).fetchone()
        
        if is_complete:
            if not existing or existing['status'] != 'complete':
                completed_at = now_ist().strftime("%Y-%m-%d %H:%M:%S")
                db.execute('''
                    INSERT OR REPLACE INTO form_completion_states 
                    (form_type, form_id, status, completed_by, completed_at)
                    VALUES (?, ?, 'complete', ?, ?)
                ''', (form_type, form_id, user_id, completed_at))
                db.commit()
                
                po_info = f"{form_data.get('customer')} - {form_data.get('po')}"
                message = f"{username} completed {form_type} form for PO: {po_info}"
                
                create_notification_for_all_users(
                    event_type='form_completed',
                    message=message,
                    actor_user_id=user_id,
                    form_type=form_type,
                    form_id=form_id,
                    exclude_user_id=user_id
                )
        else:
            if existing and existing['status'] == 'complete':
                db.execute('''
                    UPDATE form_completion_states 
                    SET status = 'in_progress'
                    WHERE form_type = ? AND form_id = ?
                ''', (form_type, form_id))
                db.commit()
        
        db.close()
    except Exception as e:
        db.close()
        print(f"Error handling form completion: {e}")

# ---------- New helpers: per-department completion and notifications ----------

def upsert_department_state(form_type, form_id, department, completed_by):
    """Mark one department as completed for a given form."""
    db = get_db()
    now = now_ist().isoformat(sep=' ')
    db.execute('''
        INSERT INTO form_department_states (form_type, form_id, department, status, completed_by, completed_at)
        VALUES (?, ?, ?, 'completed', ?, ?)
        ON CONFLICT(form_type, form_id, department) DO UPDATE SET
            status='completed', completed_by=excluded.completed_by, completed_at=excluded.completed_at
    ''', (form_type, form_id, department, completed_by, now))
    db.commit()
    db.close()

def department_is_completed(form_type, form_id, department):
    db = get_db()
    row = db.execute('''
        SELECT status FROM form_department_states
        WHERE form_type=? AND form_id=? AND department=?
    ''', (form_type, form_id, department)).fetchone()
    db.close()
    return bool(row and row['status'] == 'completed')

def all_departments_completed(form_type, form_id, dept_order):
    # check every department in order is marked completed
    for d in dept_order:
        if not department_is_completed(form_type, form_id, d):
            return False
    return True

def next_department_after(current_dept, dept_order):
    try:
        idx = dept_order.index(current_dept)
    except ValueError:
        return None
    if idx+1 < len(dept_order):
        return dept_order[idx+1]
    return None

def notify_users_of_department(department, subject, message_html, actor_user_id=None, form_type=None, form_id=None, exclude_user_id=None):
    """Notify all users in a particular department (db + email)."""
    db = get_db()
    users = db.execute('SELECT id, email, name FROM users WHERE department = ?', (department,)).fetchall()
    for u in users:
        if exclude_user_id and u['id'] == exclude_user_id:
            continue
        db.execute('''
            INSERT INTO notifications (recipient_user_id, actor_user_id, event_type, form_type, form_id, message)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (u['id'], actor_user_id, f'{form_type.lower()}_dept_completed', form_type, form_id, message_html))
        if u['email']:
            try:
                sent = send_notification_email(u['email'], subject, message_html)
                if sent:
                    db.execute('UPDATE notifications SET email_sent = 1 WHERE recipient_user_id = ? AND form_id = ? AND form_type = ?', (u['id'], form_id, form_type))
            except Exception as e:
                print("email send failed:", e)
    db.commit()
    db.close()

def notify_all_departments(subject, message_html, actor_user_id=None, form_type=None, form_id=None, exclude_user_id=None):
    """Notify all users in the system (db + email)."""
    db = get_db()
    users = db.execute('SELECT id, email, name FROM users').fetchall()
    for u in users:
        if exclude_user_id and u['id'] == exclude_user_id:
            continue
        db.execute('''
            INSERT INTO notifications (recipient_user_id, actor_user_id, event_type, form_type, form_id, message)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (u['id'], actor_user_id, f'{form_type.lower()}_all_completed', form_type, form_id, message_html))
        if u['email']:
            try:
                sent = send_notification_email(u['email'], subject, message_html)
                if sent:
                    db.execute('UPDATE notifications SET email_sent = 1 WHERE recipient_user_id = ? AND form_id = ? AND form_type = ?', (u['id'], form_id, form_type))
            except Exception as e:
                print("email send failed:", e)
    db.commit()
    db.close()

# ---------- NEW: helper to map CR items for sync into PED/LEAD ----------

def get_cr_common_item_map(db, po_key):
    """
    Return a dict keyed by item_no for CR form of this po_key with core item fields:
    { item_no: { 'part_number': ..., 'part_description': ..., 'rev': ..., 'qty': ... }, ... }
    """
    try:
        cr_form = db.execute(
            'SELECT id FROM cr_forms WHERE po_key = ?',
            (po_key,)
        ).fetchone()
        if not cr_form:
            return {}
        cr_rows = db.execute(
            '''SELECT item_no, part_number, part_description, rev, qty
               FROM cr_form_rows
               WHERE cr_form_id = ?
               ORDER BY id''',
            (cr_form['id'],)
        ).fetchall()
        result = {}
        for r in cr_rows:
            key = (r['item_no'] or '').strip()
            if not key:
                continue
            result[key] = {
                'part_number': r['part_number'] or '',
                'part_description': r['part_description'] or '',
                'rev': r['rev'] or '',
                'qty': r['qty'] or ''
            }
        return result
    except Exception as e:
        print("get_cr_common_item_map error:", e)
        return {}

# ---------- Admin helper: collect form status for dashboard ----------

def get_form_department_status_for_admin():
    """
    Return a list of all forms (CR, PED, LEAD) with:
    - basic PO info
    - overall completion status (for CR/PED, forced to 'complete' only when all departments are completed)
    - per-department completion flags (for CR/PED)
    - a 'date' field (YYYY-MM-DD) based on last activity
    """
    db = get_db()
    results = []

    def dept_states(form_type, form_ids):
        if not form_ids:
            return {}
        placeholders = ','.join('?' for _ in form_ids)
        rows = db.execute(f'''
            SELECT form_type, form_id, department, status
            FROM form_department_states
            WHERE form_type = ?
              AND form_id IN ({placeholders})
        ''', [form_type] + list(form_ids)).fetchall()
        out = {}
        for r in rows:
            key = r['form_id']
            if key not in out:
                out[key] = {}
            out[key][r['department']] = r['status']
        return out

    def pick_activity_date(row, fallback_field):
        """
        Prefer completed_at (from form_completion_states),
        else use form's own last_modified_at or record_date.
        Returns ISO 'YYYY-MM-DD' or ''.
        """
        raw = (row['completed_at']
               or row['last_modified_at']
               or row[fallback_field])
        if not raw:
            return ''
        return str(raw)[:10]

    # ---------- CR ----------
    cr_forms = db.execute('''
        SELECT f.id,
               f.po_key, f.customer, f.bid, f.po, f.cr,
               f.last_modified_at,
               s.status AS overall_status, s.completed_at
        FROM cr_forms f
        LEFT JOIN form_completion_states s
          ON s.form_type = 'CR' AND s.form_id = f.id
        ORDER BY f.id DESC
    ''').fetchall()
    cr_ids = [r['id'] for r in cr_forms]
    cr_dept = dept_states('CR', cr_ids)

    for f in cr_forms:
        # per-department map for this form
        dept_map = cr_dept.get(f['id'], {})
        dept_info = []
        for d in CR_DEPT_ORDER:
            state = dept_map.get(d, 'in_progress')
            dept_info.append({
                'department': d,
                'status': state
            })

        # --- compute "dashboard overallStatus" for CR ---
        base_status = f['overall_status'] or 'in_progress'
        # All departments must be 'completed' to be considered fully done
        all_depts_done = all(
            dept_map.get(d) == 'completed'
            for d in CR_DEPT_ORDER
        ) if CR_DEPT_ORDER else True

        if base_status == 'complete' and all_depts_done:
            dashboard_status = 'complete'
        else:
            dashboard_status = 'in_progress'

        results.append({
            'formType': 'CR',
            'formId': f['id'],
            'poKey': f['po_key'],
            'customer': f['customer'],
            'bid': f['bid'],
            'po': f['po'],
            'cr': f['cr'],
            'overallStatus': dashboard_status,
            'completedAt': f['completed_at'],
            'date': pick_activity_date(f, 'last_modified_at'),
            'departments': dept_info
        })

    # ---------- PED ----------
    ped_forms = db.execute('''
        SELECT f.id,
               f.po_key, f.customer, f.bid, f.po, f.cr,
               f.last_modified_at,
               s.status AS overall_status, s.completed_at
        FROM ped_forms f
        LEFT JOIN form_completion_states s
          ON s.form_type = 'PED' AND s.form_id = f.id
        ORDER BY f.id DESC
    ''').fetchall()
    ped_ids = [r['id'] for r in ped_forms]
    ped_dept = dept_states('PED', ped_ids)

    for f in ped_forms:
        dept_map = ped_dept.get(f['id'], {})
        dept_info = []
        for d in PED_DEPT_ORDER:
            state = dept_map.get(d, 'in_progress')
            dept_info.append({
                'department': d,
                'status': state
            })

        base_status = f['overall_status'] or 'in_progress'
        all_depts_done = all(
            dept_map.get(d) == 'completed'
            for d in PED_DEPT_ORDER
        ) if PED_DEPT_ORDER else True

        if base_status == 'complete' and all_depts_done:
            dashboard_status = 'complete'
        else:
            dashboard_status = 'in_progress'

        results.append({
            'formType': 'PED',
            'formId': f['id'],
            'poKey': f['po_key'],
            'customer': f['customer'],
            'bid': f['bid'],
            'po': f['po'],
            'cr': f['cr'],
            'overallStatus': dashboard_status,
            'completedAt': f['completed_at'],
            'date': pick_activity_date(f, 'last_modified_at'),
            'departments': dept_info
        })

    # ---------- LEAD ----------
    lead_forms = db.execute('''
        SELECT f.id,
               f.po_key, f.customer, f.bid, f.po, f.cr,
               f.last_modified_at,
               s.status AS overall_status, s.completed_at
        FROM lead_forms f
        LEFT JOIN form_completion_states s
          ON s.form_type = 'LEAD' AND s.form_id = f.id
        ORDER BY f.id DESC
    ''').fetchall()
    for f in lead_forms:
        results.append({
            'formType': 'LEAD',
            'formId': f['id'],
            'poKey': f['po_key'],
            'customer': f['customer'],
            'bid': f['bid'],
            'po': f['po'],
            'cr': f['cr'],
            'overallStatus': f['overall_status'] or 'in_progress',
            'completedAt': f['completed_at'],
            'date': pick_activity_date(f, 'last_modified_at'),
            'departments': []
        })

    db.close()
    return results

#------- PO-level overview (traffic light per form) ----------------

def get_po_overview():
    """
    Return one row per PO with form statuses:

    [
      {
        "poId": 1,
        "customer": "...",
        "bid": "...",
        "po": "...",
        "cr": "...",
        "crStatus": "not_started|in_progress|complete",
        "pedStatus": "not_started|in_progress|complete",
        "leadStatus": "not_started|in_progress|complete",
        "oldestActivity": "YYYY-MM-DD" or "",
        "latestActivity": "YYYY-MM-DD" or ""
      },
      ...
    ]
    """
    db = get_db()

    # --- Base POs ---
    po_rows = db.execute('''
        SELECT id, customer, bid, po, cr
        FROM pos
        ORDER BY id DESC
    ''').fetchall()

    # --- Forms by po_key ---
    cr_forms = db.execute('SELECT id, po_key, last_modified_at FROM cr_forms').fetchall()
    ped_forms = db.execute('SELECT id, po_key, last_modified_at FROM ped_forms').fetchall()
    lead_forms = db.execute('SELECT id, po_key, last_modified_at FROM lead_forms').fetchall()

    # Map po_key -> form info
    def index_forms(rows):
        out = {}
        for r in rows:
            key = r['po_key']
            if key not in out:
                out[key] = []
            out[key].append(r)
        return out

    cr_by_key = index_forms(cr_forms)
    ped_by_key = index_forms(ped_forms)
    lead_by_key = index_forms(lead_forms)

    # --- Completion states for all forms ---
    states = db.execute('''
        SELECT form_type, form_id, status, completed_at
        FROM form_completion_states
    ''').fetchall()
    state_index = {}
    for s in states:
        state_index[(s['form_type'], s['form_id'])] = {
            'status': s['status'],
            'completed_at': s['completed_at']
        }

    # Helper to compute status & activity date for a list of forms of one type
    def summarize_form_list(form_type, forms_for_po):
        if not forms_for_po:
            return 'not_started', None, None

        any_in_progress = False
        any_complete = False
        dates = []

        for frm in forms_for_po:
            st = state_index.get((form_type, frm['id']), {})
            status = st.get('status') or 'in_progress'
            if status == 'complete':
                any_complete = True
            else:
                any_in_progress = True

            # collect activity timestamps
            if st.get('completed_at'):
                dates.append(str(st['completed_at']))
            if frm['last_modified_at']:
                dates.append(str(frm['last_modified_at']))

        # pick traffic-light style status
        if any_in_progress:
            summary_status = 'in_progress'
        elif any_complete:
            summary_status = 'complete'
        else:
            summary_status = 'in_progress'

        if dates:
            dates_sorted = sorted(dates)
            oldest = dates_sorted[0][:10]
            newest = dates_sorted[-1][:10]
        else:
            oldest = newest = None

        return summary_status, oldest, newest

    overview = []

    # We will link pos <-> forms via shared key: customer|bid|po|cr
    for po in po_rows:
        po_key = f"{po['customer']}|{po['bid']}|{po['po']}|{po['cr']}"

        cr_list = cr_by_key.get(po_key, [])
        ped_list = ped_by_key.get(po_key, [])
        lead_list = lead_by_key.get(po_key, [])

        cr_status, cr_oldest, cr_newest = summarize_form_list('CR', cr_list)
        ped_status, ped_oldest, ped_newest = summarize_form_list('PED', ped_list)
        lead_status, lead_oldest, lead_newest = summarize_form_list('LEAD', lead_list)

        # Overall activity range for this PO
        all_dates = [d for d in [cr_oldest, cr_newest, ped_oldest, ped_newest, lead_oldest, lead_newest] if d]
        if all_dates:
            all_dates_sorted = sorted(all_dates)
            oldest_activity = all_dates_sorted[0]
            latest_activity = all_dates_sorted[-1]
        else:
            oldest_activity = ''
            latest_activity = ''

        overview.append({
            'poId': po['id'],
            'customer': po['customer'],
            'bid': po['bid'],
            'po': po['po'],
            'cr': po['cr'],
            'crStatus': cr_status,
            'pedStatus': ped_status,
            'leadStatus': lead_status,
            'oldestActivity': oldest_activity,
            'latestActivity': latest_activity,
        })

    db.close()
    return overview

# ---------- Admin endpoints for dashboard + reminders ----------

@app.route('/api/admin/forms/status', methods=['GET'])
@admin_required
def admin_forms_status():
    """
    Simple status for all CR / PED / LEAD forms (no date summary).
    Optional query params:
      - formType=CR|PED|LEAD
      - onlyPending=true (filter to in_progress)
    """
    form_type_filter = (request.args.get('formType') or '').strip().upper()
    only_pending = (request.args.get('onlyPending') or '').lower() == 'true'

    try:
        data = get_form_department_status_for_admin()
        if form_type_filter in ('CR', 'PED', 'LEAD'):
            data = [f for f in data if f['formType'] == form_type_filter]
        if only_pending:
            data = [f for f in data if f['overallStatus'] != 'complete']
        return jsonify({'forms': data})
    except Exception as e:
        print("admin_forms_status error:", e)
        return jsonify({'error': str(e)}), 500

@app.route('/api/admin/forms/status-by-date', methods=['GET'])
@admin_required
def admin_forms_status_by_date():
    """
    Return status for CR / PED / LEAD forms with per-date summary.

    Query params (all optional):
      - date=YYYY-MM-DD  -> filter forms to that date only
      - formType=CR|PED|LEAD
      - onlyPending=true (filter to in_progress)
    Response:
      {
        "dates": [ { "date": "...", "stats": { total, pending, completed, byType:{...} } }, ... ],
        "forms": [ ... ]    # filtered forms
      }
    """
    form_type_filter = (request.args.get('formType') or '').strip().upper()
    only_pending = (request.args.get('onlyPending') or '').lower() == 'true'
    date_filter = (request.args.get('date') or '').strip()  # "YYYY-MM-DD"

    try:
        all_data = get_form_department_status_for_admin()

        # normalize date field
        for f in all_data:
            d = (f.get('date') or '')[:10]
            f['date'] = d

        # apply filters
        forms = all_data
        if form_type_filter in ('CR', 'PED', 'LEAD'):
            forms = [f for f in forms if f['formType'] == form_type_filter]
        if only_pending:
            forms = [f for f in forms if f['overallStatus'] != 'complete']
        if date_filter:
            forms = [f for f in forms if f['date'] == date_filter]

        # build date summary from the filtered set
        from collections import defaultdict
        date_stats = defaultdict(lambda: {
            'total': 0,
            'pending': 0,
            'completed': 0,
            'byType': {
                'CR': {'total': 0, 'pending': 0, 'completed': 0},
                'PED': {'total': 0, 'pending': 0, 'completed': 0},
                'LEAD': {'total': 0, 'pending': 0, 'completed': 0},
            }
        })

        for f in forms:
            d = f['date'] or 'Unknown'
            t = f['formType']
            st = f['overallStatus'] or 'in_progress'
            bucket = date_stats[d]
            bucket['total'] += 1
            if st == 'complete':
                bucket['completed'] += 1
                bucket['byType'][t]['completed'] += 1
            else:
                bucket['pending'] += 1
                bucket['byType'][t]['pending'] += 1
            bucket['byType'][t]['total'] += 1

        # sort dates descending
        dates_sorted = sorted(date_stats.items(), key=lambda x: x[0], reverse=True)
        dates_payload = [
            {
                'date': d,
                'stats': s
            } for d, s in dates_sorted
        ]

        return jsonify({
            'dates': dates_payload,
            'forms': forms
        })
    except Exception as e:
        print("admin_forms_status_by_date error:", e)
        return jsonify({'error': str(e)}), 500

@app.route('/api/admin/po-overview', methods=['GET'])
@admin_required
def admin_po_overview():
    """
    Traffic-light style overview per PO.
    Optional query params:
      - onlyPending=true  (filter POs where any formStatus != 'complete')
    """
    only_pending = (request.args.get('onlyPending') or '').lower() == 'true'
    try:
        rows = get_po_overview()
        if only_pending:
            filtered = []
            for r in rows:
                if r['crStatus'] != 'complete' or r['pedStatus'] != 'complete' or r['leadStatus'] != 'complete':
                    filtered.append(r)
            rows = filtered
        return jsonify({'pos': rows})
    except Exception as e:
        print("admin_po_overview error:", e)
        return jsonify({'error': str(e)}), 500

@app.route('/api/admin/forms/remind', methods=['POST'])
@admin_required
def admin_remind_department():
    """
    Body JSON:
    {
      "formType": "CR" | "PED" | "LEAD",
      "formId": 123,
      "department": "engineering",      # required for CR/PED, ignored for LEAD
      "userId": 5,                      # optional (narrow to one user)
      "customMessage": "..."            # optional override message
    }
    """
    data = request.get_json() or {}
    form_type = (data.get('formType') or '').strip().upper()
    form_id = data.get('formId')
    department = (data.get('department') or '').strip().lower()
    user_id_target = data.get('userId')
    custom_message = (data.get('customMessage') or '').strip()

    if form_type not in ('CR', 'PED', 'LEAD'):
        return jsonify({'error': 'Invalid formType'}), 400
    if not form_id:
        return jsonify({'error': 'formId is required'}), 400

    db = get_db()
    try:
        # load form basic info
        if form_type == 'CR':
            form = db.execute('SELECT po_key, customer, po, cr FROM cr_forms WHERE id = ?', (form_id,)).fetchone()
            valid_depts = CR_DEPT_ORDER
        elif form_type == 'PED':
            form = db.execute('SELECT po_key, customer, po, cr FROM ped_forms WHERE id = ?', (form_id,)).fetchone()
            valid_depts = PED_DEPT_ORDER
        else:
            form = db.execute('SELECT po_key, customer, po, cr FROM lead_forms WHERE id = ?', (form_id,)).fetchone()
            valid_depts = []

        if not form:
            db.close()
            return jsonify({'error': f'{form_type} form not found'}), 404

        actor_user_id = session.get('user_id')
        actor_name = session.get('user_name', session.get('username', 'Admin'))

        po_info = f"{form['customer']} - {form['po']} (CR: {form['cr']})"

        if form_type in ('CR', 'PED'):
            if department not in valid_depts:
                db.close()
                return jsonify({'error': 'Invalid or unsupported department for this form type'}), 400

            # select recipients
            if user_id_target:
                users = db.execute(
                    'SELECT id, email, name FROM users WHERE id = ? AND department = ?',
                    (user_id_target, department)
                ).fetchall()
            else:
                users = db.execute(
                    'SELECT id, email, name FROM users WHERE department = ?',
                    (department,)
                ).fetchall()

            if not users:
                db.close()
                return jsonify({'error': 'No users found for this department / userId'}), 404

            subject = f"Reminder: {form_type} Review Pending ({department.title()})"
            if custom_message:
                msg_html = f"<p>{custom_message}</p>"
            else:
                msg_html = (
                    f"<p>Dear {department.title()} Team,</p>"
                    f"<p>This is a reminder that your review is pending "
                    f"for {form_type} form of PO: <strong>{po_info}</strong>.</p>"
                    f"<p>Please complete your section in the Contract Review Dashboard.</p>"
                    f"<p>Regards,<br>{actor_name}</p>"
                )

            # create notifications + send emails
            for u in users:
                notif_message = f"{actor_name} sent a reminder to {department} for {form_type} form ({po_info})."
                db.execute('''
                    INSERT INTO notifications
                    (recipient_user_id, actor_user_id, event_type, form_type, form_id, message)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (u['id'], actor_user_id, f'{form_type.lower()}_dept_reminder', form_type, form_id, notif_message))

                if u['email']:
                    try:
                        sent = send_notification_email(
                            u['email'],
                            subject,
                            msg_html
                        )
                        if sent:
                            db.execute('''
                                UPDATE notifications
                                SET email_sent = 1
                                WHERE recipient_user_id = ? AND form_type = ? AND form_id = ?
                            ''', (u['id'], form_type, form_id))
                    except Exception as e:
                        print("Reminder email send failed:", e)

            db.commit()
            db.close()
            return jsonify({'success': True, 'sentTo': [u['id'] for u in users]})

        else:
            # LEAD: no department split, remind all users (or optionally single user if given)
            if user_id_target:
                users = db.execute(
                    'SELECT id, email, name FROM users WHERE id = ?',
                    (user_id_target,)
                ).fetchall()
            else:
                users = db.execute('SELECT id, email, name FROM users').fetchall()

            if not users:
                db.close()
                return jsonify({'error': 'No users found'}), 404

            subject = f"Reminder: LEAD Form Pending"
            if custom_message:
                msg_html = f"<p>{custom_message}</p>"
            else:
                msg_html = (
                    f"<p>This is a reminder that the LEAD form for "
                    f"PO: <strong>{po_info}</strong> is still pending.</p>"
                    f"<p>Please review and complete it in the Contract Review Dashboard.</p>"
                    f"<p>Regards,<br>{actor_name}</p>"
                )

            for u in users:
                notif_message = f"{actor_name} sent a reminder for LEAD form ({po_info})."
                db.execute('''
                    INSERT INTO notifications
                    (recipient_user_id, actor_user_id, event_type, form_type, form_id, message)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (u['id'], actor_user_id, 'lead_form_reminder', form_type, form_id, notif_message))

                if u['email']:
                    try:
                        sent = send_notification_email(
                            u['email'],
                            subject,
                            msg_html
                        )
                        if sent:
                            db.execute('''
                                UPDATE notifications
                                SET email_sent = 1
                                WHERE recipient_user_id = ? AND form_type = ? AND form_id = ?
                            ''', (u['id'], form_type, form_id))
                    except Exception as e:
                        print("Reminder email send failed:", e)

            db.commit()
            db.close()
            return jsonify({'success': True, 'sentTo': [u['id'] for u in users]})

    except Exception as e:
        db.close()
        print("admin_remind_department error:", e)
        return jsonify({'error': str(e)}), 500

# ---------- existing routes (unchanged except some minor imports moved up) ----------

@app.route('/')
def index():
    return send_from_directory('static', 'login.html')

@app.route('/<path:path>')
def serve_static(path):
    return send_from_directory('static', path)

@app.route('/api/login', methods=['POST'])
def login():
    data = request.get_json()
    username = data.get('username', '').strip()
    password = data.get('password', '')
    
    if not username or not password:
        return jsonify({'error': 'Username and password required'}), 400
    
    db = get_db()
    user = db.execute('SELECT * FROM users WHERE username = ?', (username,)).fetchone()
    db.close()
    
    if user and check_password_hash(user['password_hash'], password):
        session['user_id'] = user['id']
        session['username'] = user['username']
        session['user_department'] = user['department']
        session['user_name'] = user['name']
        session['user_is_admin'] = bool(user['is_admin'])
        
        return jsonify({
            'success': True,
            'user': {
                'username': user['username'],
                'name': user['name'],
                'department': user['department'],
                'isAdmin': bool(user['is_admin'])
            }
        })
    
    return jsonify({'error': 'Invalid username or password'}), 401

@app.route('/api/logout', methods=['POST'])
def logout():
    session.clear()
    return jsonify({'success': True})

@app.route('/api/session', methods=['GET'])
def get_session():
    if 'user_id' in session:
        return jsonify({
            'loggedIn': True,
            'user': {
                'username': session.get('username'),
                'name': session.get('user_name'),
                'department': session.get('user_department'),
                'isAdmin': session.get('user_is_admin', False)
            }
        })
    return jsonify({'loggedIn': False})

@app.route('/api/users', methods=['GET'])
@admin_required
def get_users():
    db = get_db()
    users = db.execute('SELECT id, username, name, department, email, is_admin, lead_form_access FROM users ORDER BY id').fetchall()
    db.close()
    
    return jsonify([{
        'id': user['id'],
        'username': user['username'],
        'name': user['name'],
        'department': user['department'],
        'email': user['email'] or '',
        'isAdmin': bool(user['is_admin']),
        'leadFormAccess': bool(user['lead_form_access'])
    } for user in users])

@app.route('/api/users', methods=['POST'])
@admin_required
def create_user():
    data = request.get_json()
    username = data.get('username', '').strip()
    password = data.get('password', '')
    name = data.get('name', '').strip()
    department = data.get('department', '').strip()
    email = data.get('email', '').strip()
    is_admin = data.get('isAdmin', False)
    lead_form_access = data.get('leadFormAccess', False)
    
    if not all([username, password, name, department]):
        return jsonify({'error': 'Username, password, name, and department are required'}), 400
    
    db = get_db()
    
    existing = db.execute('SELECT id FROM users WHERE username = ?', (username,)).fetchone()
    if existing:
        db.close()
        return jsonify({'error': 'Username already exists'}), 400
    
    if email:
        existing_email = db.execute('SELECT id FROM users WHERE email = ? AND email != ""', (email,)).fetchone()
        if existing_email:
            db.close()
            return jsonify({'error': 'Email already exists'}), 400
    
    try:
        db.execute(
            'INSERT INTO users (username, password_hash, name, department, email, is_admin, lead_form_access) VALUES (?, ?, ?, ?, ?, ?, ?)',
            (username, generate_password_hash(password), name, department, email, 1 if is_admin else 0, 1 if lead_form_access else 0)
        )
        db.commit()
        user_id = db.execute('SELECT last_insert_rowid() as id').fetchone()['id']
        db.close()
        
        return jsonify({
            'success': True,
            'user': {
                'id': user_id,
                'username': username,
                'name': name,
                'department': department,
                'email': email,
                'isAdmin': is_admin,
                'leadFormAccess': lead_form_access
            }
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/users/<int:user_id>', methods=['PUT'])
@admin_required
def update_user(user_id):
    data = request.get_json()
    name = data.get('name', '').strip()
    department = data.get('department', '').strip()
    email = data.get('email', '').strip()
    is_admin = data.get('isAdmin', False)
    lead_form_access = data.get('leadFormAccess', False)
    password = data.get('password', '').strip()
    
    if not all([name, department]):
        return jsonify({'error': 'Name and department required'}), 400
    
    db = get_db()
    
    user = db.execute('SELECT username, is_admin FROM users WHERE id = ?', (user_id,)).fetchone()
    if not user:
        db.close()
        return jsonify({'error': 'User not found'}), 404
    
    if email:
        existing_email = db.execute('SELECT id FROM users WHERE email = ? AND email != "" AND id != ?', (email, user_id)).fetchone()
        if existing_email:
            db.close()
            return jsonify({'error': 'Email already exists'}), 400
    
    if user['username'] == 'admin' and user['is_admin'] and not is_admin:
        admin_count = db.execute('SELECT COUNT(*) as count FROM users WHERE is_admin = 1').fetchone()['count']
        if admin_count <= 1:
            db.close()
            return jsonify({'error': 'Cannot remove admin status from last admin user'}), 400
    
    try:
        if password:
            db.execute(
                'UPDATE users SET name = ?, department = ?, email = ?, is_admin = ?, lead_form_access = ?, password_hash = ? WHERE id = ?',
                (name, department, email, 1 if is_admin else 0, 1 if lead_form_access else 0, generate_password_hash(password), user_id)
            )
        else:
            db.execute(
                'UPDATE users SET name = ?, department = ?, email = ?, is_admin = ?, lead_form_access = ? WHERE id = ?',
                (name, department, email, 1 if is_admin else 0, 1 if lead_form_access else 0, user_id)
            )
        db.commit()
        db.close()
        
        return jsonify({
            'success': True,
            'user': {
                'id': user_id,
                'username': user['username'],
                'name': name,
                'department': department,
                'email': email,
                'isAdmin': is_admin,
                'leadFormAccess': lead_form_access
            }
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/users/<int:user_id>', methods=['DELETE'])
@admin_required
def delete_user(user_id):
    db = get_db()
    
    user = db.execute('SELECT username, is_admin FROM users WHERE id = ?', (user_id,)).fetchone()
    if not user:
        db.close()
        return jsonify({'error': 'User not found'}), 404
    
    if user['username'] == 'admin' and user['is_admin']:
        db.close()
        return jsonify({'error': 'Cannot delete default admin user'}), 400
    
    admin_count = db.execute('SELECT COUNT(*) as count FROM users WHERE is_admin = 1').fetchone()['count']
    if user['is_admin'] and admin_count <= 1:
        db.close()
        return jsonify({'error': 'Cannot delete last admin user'}), 400
    
    db.execute('DELETE FROM users WHERE id = ?', (user_id,))
    db.commit()
    db.close()
    
    return jsonify({'success': True})

@app.route('/api/pos', methods=['GET'])
@login_required
def get_pos():
    db = get_db()
    pos_list = db.execute('SELECT * FROM pos ORDER BY id DESC').fetchall()
    db.close()
    
    return jsonify([{
        'id': po['id'],
        'customer': po['customer'],
        'bid': po['bid'],
        'po': po['po'],
        'cr': po['cr']
    } for po in pos_list])

@app.route('/api/pos', methods=['POST'])
@admin_required
def create_po():
    data = request.get_json()
    customer = data.get('customer', '').strip()
    bid = data.get('bid', '').strip()
    po = data.get('po', '').strip()
    cr = data.get('cr', '').strip()
    
    if not all([customer, bid, po, cr]):
        return jsonify({'error': 'All fields required'}), 400
    
    db = get_db()
    try:
        db.execute(
            'INSERT INTO pos (customer, bid, po, cr) VALUES (?, ?, ?, ?)',
            (customer, bid, po, cr)
        )
        db.commit()
        po_id = db.execute('SELECT last_insert_rowid() as id').fetchone()['id']
        db.close()
        
        actor_user_id = session.get('user_id')
        actor_username = session.get('username', 'Admin')
        message = f"New PO created by {actor_username}: {customer} - {po} (CR: {cr})"
        
        create_notification_for_all_users(
            event_type='po_created',
            message=message,
            actor_user_id=actor_user_id,
            po_id=po_id,
            exclude_user_id=actor_user_id
        )
        
        return jsonify({
            'success': True,
            'po': {
                'id': po_id,
                'customer': customer,
                'bid': bid,
                'po': po,
                'cr': cr
            }
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/pos/<int:po_id>', methods=['PUT'])
@admin_required
def update_po(po_id):
    data = request.get_json()
    customer = data.get('customer', '').strip()
    bid = data.get('bid', '').strip()
    po = data.get('po', '').strip()
    cr = data.get('cr', '').strip()
    
    if not all([customer, bid, po, cr]):
        return jsonify({'error': 'All fields required'}), 400
    
    db = get_db()
    db.execute(
        'UPDATE pos SET customer = ?, bid = ?, po = ?, cr = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?',
        (customer, bid, po, cr, po_id)
    )
    db.commit()
    db.close()
    
    return jsonify({
        'success': True,
        'po': {
            'id': po_id,
            'customer': customer,
            'bid': bid,
            'po': po,
            'cr': cr
        }
    })

@app.route('/api/pos/<int:po_id>', methods=['DELETE'])
@admin_required
def delete_po(po_id):
    db = get_db()
    db.execute('DELETE FROM pos WHERE id = ?', (po_id,))
    db.commit()
    db.close()
    
    return jsonify({'success': True})

@app.route('/api/backup', methods=['GET'])
@admin_required
def backup_data():
    db = get_db()
    users = db.execute('SELECT id, username, password_hash, name, department, is_admin FROM users').fetchall()
    pos_list = db.execute('SELECT * FROM pos').fetchall()
    db.close()
    
    return jsonify({
        'meta': {
            'app': 'GTN-ContractReview',
            'version': '1.0',
            'exportedAt': now_ist().isoformat(),
            'by': session.get('username', '')
        },
        'users': [{
            'username': u['username'],
            'password_hash': u['password_hash'],
            'name': u['name'],
            'department': u['department'],
            'isAdmin': bool(u['is_admin'])
        } for u in users],
        'pos': [{
            'customer': p['customer'],
            'bid': p['bid'],
            'po': p['po'],
            'cr': p['cr']
        } for p in pos_list]
    })

@app.route('/api/restore', methods=['POST'])
@admin_required
def restore_data():
    data = request.get_json()
    
    if not data or not isinstance(data, dict):
        return jsonify({'error': 'Invalid data format'}), 400
    
    if not data.get('users') or not isinstance(data['users'], list):
        return jsonify({'error': 'Missing or invalid users array'}), 400
    
    if not data.get('pos') or not isinstance(data['pos'], list):
        return jsonify({'error': 'Missing or invalid pos array'}), 400
    
    for user in data['users']:
        if not all(key in user for key in ['username', 'password_hash', 'name', 'department']):
            return jsonify({'error': 'Invalid user data: missing required fields'}), 400
        if not user.get('password_hash') or not user['password_hash'].startswith(('pbkdf2:', 'scrypt:', 'bcrypt:')):
            return jsonify({'error': 'Invalid user data: password_hash must be a valid hash'}), 400
    
    has_admin = any(u.get('isAdmin') for u in data['users'])
    if not has_admin:
        return jsonify({'error': 'Backup must contain at least one admin user'}), 400
    
    for po in data['pos']:
        if not all(key in po for key in ['customer', 'bid', 'po', 'cr']):
            return jsonify({'error': 'Invalid PO data: missing required fields'}), 400
    
    db = get_db()
    try:
        db.execute('BEGIN TRANSACTION')
        
        db.execute('DELETE FROM users')
        db.execute('DELETE FROM pos')
        
        for user in data['users']:
            db.execute(
                'INSERT INTO users (username, password_hash, name, department, is_admin) VALUES (?, ?, ?, ?, ?)',
                (user['username'], user['password_hash'], 
                 user['name'], user['department'], 1 if user.get('isAdmin') else 0)
            )
        
        for po in data['pos']:
            db.execute(
                'INSERT INTO pos (customer, bid, po, cr) VALUES (?, ?, ?, ?)',
                (po['customer'], po['bid'], po['po'], po['cr'])
            )
        
        db.commit()
        db.close()
        return jsonify({'success': True})
    except Exception as e:
        db.rollback()
        db.close()
        return jsonify({'error': str(e)}), 500

# ---------- CR/PED/LEAD save & load routes ----------

@app.route('/api/cr-form/save', methods=['POST'])
@login_required
def save_cr_form():
    import json
    data = request.get_json()
    
    po_key = data.get('poKey', '').strip()
    if not po_key:
        return jsonify({'error': 'PO key required'}), 400
    
    customer = data.get('customer', '').strip()
    bid = data.get('bid', '').strip()
    po = data.get('po', '').strip()
    cr = data.get('cr', '').strip()
    record_no = data.get('recordNo', '').strip()
    record_date = data.get('recordDate', '').strip()
    rows = data.get('rows', [])
    
    username = session.get('username', 'unknown')
    is_admin = session.get('user_is_admin', False)
    
    db = get_db()
    try:
        db.execute('BEGIN TRANSACTION')
        
        cursor = db.execute('SELECT id, amendment_details FROM cr_forms WHERE po_key = ?', (po_key,))
        form = cursor.fetchone()
        
        if is_admin:
            amendment_details = data.get('amendmentDetails', '').strip()
        else:
            amendment_details = form['amendment_details'] if form else ''
        
        if form:
            form_id = form['id']
            db.execute('''
                UPDATE cr_forms 
                SET customer = ?, bid = ?, po = ?, cr = ?, record_no = ?, record_date = ?, amendment_details = ?,
                    last_modified_by = ?, last_modified_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (customer, bid, po, cr, record_no, record_date, amendment_details, username, form_id))
            
            db.execute('DELETE FROM cr_form_rows WHERE cr_form_id = ?', (form_id,))
        else:
            db.execute('''
                INSERT INTO cr_forms (po_key, customer, bid, po, cr, record_no, record_date, amendment_details, last_modified_by)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (po_key, customer, bid, po, cr, record_no, record_date, amendment_details, username))
            form_id = db.execute('SELECT last_insert_rowid() as id').fetchone()['id']
        
        for row in rows:
            item_no = row.get('key', '')
            if not item_no:
                continue
            
            cycles_json = json.dumps(row.get('cycles', []))
            
            db.execute('''
                INSERT INTO cr_form_rows 
                (cr_form_id, item_no, part_number, part_description, rev, qty, cycles, remarks)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                form_id,
                item_no,
                row.get('part', ''),
                row.get('desc', ''),
                row.get('rev', ''),
                row.get('qty', ''),
                cycles_json,
                row.get('remarks', '')
            ))
        
        db.commit()
        db.close()
        
        user_id = session.get('user_id')
        handle_form_completion_notification('CR', form_id, data, user_id, username)
        
        return jsonify({
            'success': True,
            'lastModifiedBy': username,
            'lastModifiedAt': now_ist().isoformat()
        })
    except Exception as e:
        db.rollback()
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/cr-form/load', methods=['GET'])
@login_required
def load_cr_form():
    import json
    po_key = request.args.get('poKey', '').strip()
    if not po_key:
        return jsonify({'error': 'PO key required'}), 400
    
    db = get_db()
    try:
        cursor = db.execute('''
            SELECT id, customer, bid, po, cr, record_no, record_date, amendment_details, last_modified_by, last_modified_at
            FROM cr_forms
            WHERE po_key = ?
        ''', (po_key,))
        form = cursor.fetchone()
        
        if not form:
            db.close()
            return jsonify({'exists': False})
        
        form_id = form['id']
        
        rows_cursor = db.execute('''
            SELECT item_no, part_number, part_description, rev, qty, cycles, remarks
            FROM cr_form_rows
            WHERE cr_form_id = ?
            ORDER BY id
        ''', (form_id,))
        
        rows = []
        for row in rows_cursor.fetchall():
            cycles = json.loads(row['cycles']) if row['cycles'] else []
            rows.append({
                'key': row['item_no'],
                'part': row['part_number'] or '',
                'desc': row['part_description'] or '',
                'rev': row['rev'] or '',
                'qty': row['qty'] or '',
                'cycles': cycles,
                'remarks': row['remarks'] or ''
            })
        
        db.close()
        
        return jsonify({
            'exists': True,
            'formId': form_id,
            'customer': form['customer'] or '',
            'bid': form['bid'] or '',
            'po': form['po'] or '',
            'cr': form['cr'] or '',
            'recordNo': form['record_no'] or '',
            'recordDate': form['record_date'] or '',
            'amendmentDetails': form['amendment_details'] or '',
            'rows': rows,
            'lastModifiedBy': form['last_modified_by'] or '',
            'lastModifiedAt': form['last_modified_at'] or ''
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/ped-form/save', methods=['POST'])
@login_required
def save_ped_form():
    import json
    data = request.get_json()
    
    po_key = data.get('poKey', '').strip()
    if not po_key:
        return jsonify({'error': 'PO key required'}), 400
    
    customer = data.get('customer', '').strip()
    bid = data.get('bid', '').strip()
    po = data.get('po', '').strip()
    cr = data.get('cr', '').strip()
    record_no = data.get('recordNo', '').strip()
    record_date = data.get('recordDate', '').strip()
    rows = data.get('rows', [])
    
    username = session.get('username', 'unknown')
    is_admin = session.get('user_is_admin', False)
    
    db = get_db()
    try:
        db.execute('BEGIN TRANSACTION')
        
        cursor = db.execute('SELECT id, amendment_details FROM ped_forms WHERE po_key = ?', (po_key,))
        form = cursor.fetchone()
        
        if is_admin:
            amendment_details = data.get('amendmentDetails', '').strip()
        else:
            amendment_details = form['amendment_details'] if form else ''
        
        if form:
            form_id = form['id']
            db.execute('''
                UPDATE ped_forms 
                SET customer = ?, bid = ?, po = ?, cr = ?, record_no = ?, record_date = ?, amendment_details = ?,
                    last_modified_by = ?, last_modified_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (customer, bid, po, cr, record_no, record_date, amendment_details, username, form_id))
            
            db.execute('DELETE FROM ped_form_rows WHERE ped_form_id = ?', (form_id,))
        else:
            db.execute('''
                INSERT INTO ped_forms (po_key, customer, bid, po, cr, record_no, record_date, amendment_details, last_modified_by)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (po_key, customer, bid, po, cr, record_no, record_date, amendment_details, username))
            form_id = db.execute('SELECT last_insert_rowid() as id').fetchone()['id']

        # NEW: get CR item map to sync shared fields
        cr_item_map = get_cr_common_item_map(db, po_key)
        
        for row in rows:
            item_no = row.get('key', '')
            if not item_no:
                continue

            # default values from incoming JSON
            part_number = row.get('part', '')
            part_description = row.get('desc', '')
            rev = row.get('rev', '')
            qty = row.get('qty', '')

            # if CR has this item_no, override from CR to keep consistent
            cr_item = cr_item_map.get(str(item_no).strip())
            if cr_item:
                if not part_number:
                    part_number = cr_item['part_number']
                if not part_description:
                    part_description = cr_item['part_description']
                if not rev:
                    rev = cr_item['rev']
                if not qty:
                    qty = cr_item['qty']
            
            ped_cycles_json = json.dumps(row.get('pedCycles', []))
            notes_json = json.dumps(row.get('notes', []))
            
            db.execute('''
                INSERT INTO ped_form_rows 
                (ped_form_id, item_no, part_number, part_description, rev, qty, ped_cycles, notes, remarks)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                form_id,
                item_no,
                part_number,
                part_description,
                rev,
                qty,
                ped_cycles_json,
                notes_json,
                row.get('remarks', '')
            ))
        
        db.commit()
        db.close()
        
        user_id = session.get('user_id')
        handle_form_completion_notification('PED', form_id, data, user_id, username)
        
        return jsonify({
            'success': True,
            'lastModifiedBy': username,
            'lastModifiedAt': now_ist().isoformat()
        })
    except Exception as e:
        db.rollback()
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/ped-form/load', methods=['GET'])
@login_required
def load_ped_form():
    import json
    po_key = request.args.get('poKey', '').strip()
    if not po_key:
        return jsonify({'error': 'PO key required'}), 400
    
    db = get_db()
    try:
        cursor = db.execute('''
            SELECT id, customer, bid, po, cr, record_no, record_date, amendment_details, last_modified_by, last_modified_at
            FROM ped_forms
            WHERE po_key = ?
        ''', (po_key,))
        form = cursor.fetchone()
        
        if not form:
            db.close()
            return jsonify({'exists': False})
        
        form_id = form['id']
        
        rows_cursor = db.execute('''
            SELECT item_no, part_number, part_description, rev, qty, ped_cycles, notes, remarks
            FROM ped_form_rows
            WHERE ped_form_id = ?
            ORDER BY id
        ''', (form_id,))
        
        rows = []
        for row in rows_cursor.fetchall():
            ped_cycles = json.loads(row['ped_cycles']) if row['ped_cycles'] else []
            notes = json.loads(row['notes']) if row['notes'] else []
            rows.append({
                'key': row['item_no'],
                'part': row['part_number'] or '',
                'desc': row['part_description'] or '',
                'rev': row['rev'] or '',
                'qty': row['qty'] or '',
                'pedCycles': ped_cycles,
                'notes': notes,
                'remarks': row['remarks'] or ''
            })
        
        db.close()
        
        return jsonify({
            'exists': True,
            'formId': form_id,
            'customer': form['customer'] or '',
            'bid': form['bid'] or '',
            'po': form['po'] or '',
            'cr': form['cr'] or '',
            'recordNo': form['record_no'] or '',
            'recordDate': form['record_date'] or '',
            'amendmentDetails': form['amendment_details'] or '',
            'rows': rows,
            'lastModifiedBy': form['last_modified_by'] or '',
            'lastModifiedAt': form['last_modified_at'] or ''
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/lead-form/save', methods=['POST'])
@login_required
def save_lead_form():
    import json
    data = request.get_json()
    
    po_key = data.get('poKey', '').strip()
    if not po_key:
        return jsonify({'error': 'PO key required'}), 400
    
    customer = data.get('customer', '').strip()
    bid = data.get('bid', '').strip()
    po = data.get('po', '').strip()
    cr = data.get('cr', '').strip()
    record_no = data.get('recordNo', '').strip()
    record_date = data.get('recordDate', '').strip()
    general_remarks = data.get('generalRemarks', '').strip()
    rows = data.get('rows', [])
    
    username = session.get('username', 'unknown')
    
    db = get_db()
    try:
        db.execute('BEGIN TRANSACTION')
        
        cursor = db.execute('SELECT id FROM lead_forms WHERE po_key = ?', (po_key,))
        form = cursor.fetchone()
        
        if form:
            form_id = form['id']
            db.execute('''
                UPDATE lead_forms 
                SET customer = ?, bid = ?, po = ?, cr = ?, record_no = ?, record_date = ?, general_remarks = ?,
                    last_modified_by = ?, last_modified_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (customer, bid, po, cr, record_no, record_date, general_remarks, username, form_id))
            
            db.execute('DELETE FROM lead_form_rows WHERE lead_form_id = ?', (form_id,))
        else:
            db.execute('''
                INSERT INTO lead_forms (po_key, customer, bid, po, cr, record_no, record_date, general_remarks, last_modified_by)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (po_key, customer, bid, po, cr, record_no, record_date, general_remarks, username))
            form_id = db.execute('SELECT last_insert_rowid() as id').fetchone()['id']

        # Keep LEAD rows in sync with CR item data when available
        cr_item_map = get_cr_common_item_map(db, po_key)
        
        for row in rows:
            item_no = row.get('itemNo', '')
            if not item_no:
                continue

            part_number = row.get('part', '')
            part_description = row.get('desc', '')
            rev = row.get('rev', '')
            qty = row.get('qty', '')

            cr_item = cr_item_map.get(str(item_no).strip())
            if cr_item:
                if not part_number:
                    part_number = cr_item['part_number']
                if not part_description:
                    part_description = cr_item['part_description']
                if not rev:
                    rev = cr_item['rev']
                if not qty:
                    qty = cr_item['qty']
            
            db.execute('''
                INSERT INTO lead_form_rows 
                (lead_form_id, item_no, part_number, part_description, rev, qty, 
                 customer_required_date, standard_lead_time, gtn_agreed_date, remarks)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                form_id,
                item_no,
                part_number,
                part_description,
                rev,
                qty,
                row.get('customerRequiredDate', ''),
                row.get('standardLeadTime', ''),
                row.get('gtnAgreedDate', ''),
                row.get('remarks', '')
            ))
        
        db.commit()
        db.close()
        
        # completion notification (uses full data as before)
        user_id = session.get('user_id')
        handle_form_completion_notification('LEAD', form_id, data, user_id, username)
        
        return jsonify({
            'success': True,
            'lastModifiedBy': username,
            # IST timestamp for UI display
            'lastModifiedAt': now_ist().isoformat()
        })
    except Exception as e:
        db.rollback()
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/lead-form/load', methods=['GET'])
@login_required
def load_lead_form():
    import json
    po_key = request.args.get('poKey', '').strip()
    if not po_key:
        return jsonify({'error': 'PO key required'}), 400
    
    db = get_db()
    try:
        cursor = db.execute('''
            SELECT id, customer, bid, po, cr, record_no, record_date, general_remarks, last_modified_by, last_modified_at
            FROM lead_forms
            WHERE po_key = ?
        ''', (po_key,))
        form = cursor.fetchone()
        
        if not form:
            db.close()
            return jsonify({'exists': False})
        
        form_id = form['id']
        
        rows_cursor = db.execute('''
            SELECT item_no, part_number, part_description, rev, qty, 
                   customer_required_date, standard_lead_time, gtn_agreed_date, remarks
            FROM lead_form_rows
            WHERE lead_form_id = ?
            ORDER BY id
        ''', (form_id,))
        
        rows = []
        for row in rows_cursor.fetchall():
            rows.append({
                'itemNo': row['item_no'],
                'part': row['part_number'] or '',
                'desc': row['part_description'] or '',
                'rev': row['rev'] or '',
                'qty': row['qty'] or '',
                'customerRequiredDate': row['customer_required_date'] or '',
                'standardLeadTime': row['standard_lead_time'] or '',
                'gtnAgreedDate': row['gtn_agreed_date'] or '',
                'remarks': row['remarks'] or ''
            })
        
        db.close()
        
        return jsonify({
            'exists': True,
            'formId': form_id,
            'customer': form['customer'] or '',
            'bid': form['bid'] or '',
            'po': form['po'] or '',
            'cr': form['cr'] or '',
            'recordNo': form['record_no'] or '',
            'recordDate': form['record_date'] or '',
            'generalRemarks': form['general_remarks'] or '',
            'rows': rows,
            'lastModifiedBy': form['last_modified_by'] or '',
            'lastModifiedAt': form['last_modified_at'] or ''
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

# ------------------ CR/PED/LEAD export & comments & notifications ------------------

def build_cr_comments_excel(db, form, form_id):
    import openpyxl
    from io import BytesIO

    template_path = "attached_assets/Comments.xlsx"
    wb = openpyxl.load_workbook(template_path)
    ws = wb.active
    ws.title = "CR COMMENTS"

    # ---- Header ----
    ws['AB1'] = form['record_no'] or ''
    ws['AB2'] = form['record_date'] or ''
    ws['C3']  = form['customer'] or ''
    ws['F3']  = form['bid'] or ''
    ws['S3']  = form['po'] or ''
    ws['AC3'] = form['cr'] or ''

    # ---- Amendment Details (NEW) ----
    ws['C26'] = form['amendment_details'] or ''

    # ---- Comments ----
    comments = db.execute("""
        SELECT department, username, comment_text
        FROM cr_comments
        WHERE cr_form_id = ?
        ORDER BY created_at
    """, (form_id,)).fetchall()

    start_row = 5
    for idx, c in enumerate(comments, start=1):
        r = start_row + idx - 1
        ws[f"A{r}"] = idx
        ws[f"B{r}"] = c['department']
        ws[f"C{r}"] = "CR"
        ws[f"D{r}"] = c['username']
        ws[f"E{r}"] = c['comment_text']

    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)
    return buffer

# --- replace your existing export_cr_to_excel() with this updated version ---
@app.route('/api/cr-export-excel', methods=['GET'])
@login_required
def export_cr_to_excel():
    import json
    import openpyxl
    from openpyxl.drawing.image import Image
    from io import BytesIO
    import zipfile
    from flask import make_response, jsonify, request
    import os

    def build_merged_cell_map(ws):
        merged_map = {}
        for merged_range in ws.merged_cells.ranges:
            min_row, min_col = merged_range.min_row, merged_range.min_col
            for row in range(merged_range.min_row, merged_range.max_row + 1):
                for col in range(merged_range.min_col, merged_range.max_col + 1):
                    merged_map[(row, col)] = (min_row, min_col)
        return merged_map

    def write_cell(ws, row, col, value, merged_map):
        if (row, col) in merged_map:
            ar, ac = merged_map[(row, col)]
            ws.cell(row=ar, column=ac).value = value
        else:
            ws.cell(row=row, column=col).value = value

    # ---------------- HEADER MAPPING ----------------
    cr_header_cells = {
        'CR_1': {
            'record_no_col': 26,
            'record_date_col': 26,
            'customer_row_col': (3, 3),
            'bid_row_col': (3, 5),
            'po_row_col': (3, 15),
            'cr_row_col': (3, 25),
            'amendment_row_col': (16, 3),
        },
        'CR_2': {
            'record_no_col': 28,
            'record_date_col': 28,
            'customer_row_col': (3, 3),
            'bid_row_col': (3, 5),
            'po_row_col': (3, 18),
            'cr_row_col': (3, 28),
            'amendment_row_col': (15, 3),
        },
        'CR_3': {
            'record_no_col': 26,
            'record_date_col': 26,
            'customer_row_col': (3, 3),
            'bid_row_col': (3, 5),
            'po_row_col': (3, 15),
            'cr_row_col': (3, 25),
            'amendment_row_col': (15, 3),
        },
    }

    templates = {
        'CR_1': 'attached_assets/CR_1762338481711.xlsx',
        'CR_2': 'attached_assets/CR 2_1762338481710.xlsx',
        'CR_3': 'attached_assets/CR 3_1762338481711.xlsx'
    }

    logo_path = 'attached_assets/GTN_LOGO_1762400078631.png'

    for path in templates.values():
        if not os.path.exists(path):
            return jsonify({'error': f'Template missing: {path}'}), 404
    if not os.path.exists(logo_path):
        return jsonify({'error': 'Logo missing'}), 404

    cycle_mapping = {
        'CR_1': (0, 21),
        'CR_2': (21, 44),
        'CR_3': (44, 64),
    }

    # ---------------- NEW: filter by selected PO IDs ----------------
    po_ids_param = (request.args.get('po_ids') or '').strip()
    po_ids = []
    if po_ids_param:
        try:
            po_ids = [int(x) for x in po_ids_param.split(',') if x.strip().isdigit()]
        except Exception:
            po_ids = []

    db = get_db()
    try:
        forms = []

        if po_ids:
            # Map selected pos.id -> po_key and filter cr_forms by po_key
            placeholders = ",".join("?" for _ in po_ids)
            pos_rows = db.execute(
                f"SELECT customer, bid, po, cr FROM pos WHERE id IN ({placeholders})",
                po_ids
            ).fetchall()

            po_keys = [f"{p['customer']}|{p['bid']}|{p['po']}|{p['cr']}" for p in pos_rows]
            if not po_keys:
                db.close()
                return jsonify({'error': 'No matching POs found for given po_ids'}), 404

            key_placeholders = ",".join("?" for _ in po_keys)
            forms = db.execute(f'''
                SELECT id, customer, bid, po, cr,
                       record_no, record_date, amendment_details
                FROM cr_forms
                WHERE po_key IN ({key_placeholders})
                ORDER BY id
            ''', po_keys).fetchall()
        else:
            # Backward compatible: if no po_ids passed, export all (current behavior)
            forms = db.execute('''
                SELECT id, customer, bid, po, cr,
                       record_no, record_date, amendment_details
                FROM cr_forms
                ORDER BY id
            ''').fetchall()

        if not forms:
            db.close()
            return jsonify({'error': 'No CR forms found for selected POs'}), 404

        zip_buffer = BytesIO()

        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
            for idx, form in enumerate(forms):
                form_id = form['id']
                safe_customer = ''.join(
                    c for c in (form['customer'] or 'Customer')
                    if c.isalnum() or c in (' ', '_', '-')
                )[:30]

                # ========== 1) CR EXCEL FILES (3 TEMPLATES) ==========
                for template_key, template_path in templates.items():
                    wb = openpyxl.load_workbook(template_path)
                    ws = wb.active
                    ws.title = "CR"

                    merged_map = build_merged_cell_map(ws)

                    try:
                        img = Image(logo_path)
                        img.width = 80
                        img.height = 60
                        ws.add_image(img, 'A1')
                    except:
                        pass

                    cells = cr_header_cells[template_key]

                    write_cell(ws, 1, cells['record_no_col'], form['record_no'] or '', merged_map)
                    write_cell(ws, 2, cells['record_date_col'], form['record_date'] or '', merged_map)

                    write_cell(ws, *cells['customer_row_col'], form['customer'] or '', merged_map)
                    write_cell(ws, *cells['bid_row_col'], form['bid'] or '', merged_map)
                    write_cell(ws, *cells['po_row_col'], form['po'] or '', merged_map)
                    write_cell(ws, *cells['cr_row_col'], form['cr'] or '', merged_map)
                    write_cell(ws, *cells['amendment_row_col'], form['amendment_details'] or '', merged_map)

                    rows = db.execute('''
                        SELECT item_no, part_number, part_description,
                               rev, qty, cycles, remarks
                        FROM cr_form_rows
                        WHERE cr_form_id = ?
                        ORDER BY id
                    ''', (form_id,)).fetchall()

                    cycle_start, cycle_end = cycle_mapping[template_key]
                    remarks_col = 6 + (cycle_end - cycle_start)
                    excel_row = 8

                    for r in rows:
                        if excel_row > 12:
                            break

                        write_cell(ws, excel_row, 1, r['item_no'], merged_map)
                        write_cell(ws, excel_row, 2, r['part_number'], merged_map)
                        write_cell(ws, excel_row, 3, r['part_description'], merged_map)
                        write_cell(ws, excel_row, 4, r['rev'], merged_map)
                        write_cell(ws, excel_row, 5, r['qty'], merged_map)

                        cycles = json.loads(r['cycles']) if r['cycles'] else []
                        for i, v in enumerate(cycles[cycle_start:cycle_end]):
                            write_cell(ws, excel_row, 6 + i, v or '', merged_map)

                        write_cell(ws, excel_row, remarks_col, r['remarks'] or '', merged_map)
                        excel_row += 1

                    buf = BytesIO()
                    wb.save(buf)
                    buf.seek(0)
                    zip_file.writestr(
                        f"{template_key}_{idx+1}_{safe_customer}.xlsx",
                        buf.read()
                    )

                # ========== 2) CR COMMENTS EXCEL (ONCE) ==========
                comments_buffer = build_cr_comments_excel(db, form, form_id)
                zip_file.writestr(
                    f"CR_Comments_{safe_customer}.xlsx",
                    comments_buffer.read()
                )

        db.close()

        zip_buffer.seek(0)
        response = make_response(zip_buffer.read())
        response.headers['Content-Type'] = 'application/zip'
        response.headers['Content-Disposition'] = 'attachment; filename=CR_Export.zip'
        return response

    except Exception as e:
        try:
            db.close()
        except:
            pass
        return jsonify({'error': str(e)}), 500

def build_ped_comments_excel(db, form, form_id):
    import openpyxl
    from io import BytesIO

    template_path = "attached_assets/Comments.xlsx"
    wb = openpyxl.load_workbook(template_path)
    ws = wb.active
    ws.title = "PED COMMENTS"

    # ---- Header ----
    ws['AB1'] = form['record_no'] or ''
    ws['AB2'] = form['record_date'] or ''
    ws['C3']  = form['customer'] or ''
    ws['F3']  = form['bid'] or ''
    ws['S3']  = form['po'] or ''
    ws['AC3'] = form['cr'] or ''

    # ---- Amendment Details ----
    ws['C26'] = form['amendment_details'] or ''

    # ---- Comments ----
    comments = db.execute("""
        SELECT department, username, comment_text
        FROM ped_comments
        WHERE ped_form_id = ?
        ORDER BY created_at
    """, (form_id,)).fetchall()

    start_row = 5
    for idx, c in enumerate(comments, start=1):
        r = start_row + idx - 1
        ws[f"A{r}"] = idx
        ws[f"B{r}"] = c['department']
        ws[f"C{r}"] = "PED"
        ws[f"D{r}"] = c['username']
        ws[f"E{r}"] = c['comment_text']

    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)
    return buffer

@app.route('/api/ped-export-excel', methods=['GET'])
@login_required
def export_ped_to_excel():
    import json
    import openpyxl
    from openpyxl.drawing.image import Image
    from io import BytesIO
    from flask import make_response, jsonify, request
    import os
    import zipfile

    # ---------------- HELPERS ----------------
    def build_merged_cell_map(ws):
        merged_map = {}
        for mr in ws.merged_cells.ranges:
            r0, c0 = mr.min_row, mr.min_col
            for r in range(mr.min_row, mr.max_row + 1):
                for c in range(mr.min_col, mr.max_col + 1):
                    merged_map[(r, c)] = (r0, c0)
        return merged_map

    def write_cell(ws, row, col, value, merged_map):
        if (row, col) in merged_map:
            ar, ac = merged_map[(row, col)]
            ws.cell(row=ar, column=ac).value = value
        else:
            ws.cell(row=row, column=col).value = value

    def build_ped_comments_excel(db, form, form_id):
        from io import BytesIO
        import openpyxl

        wb = openpyxl.load_workbook("attached_assets/Comments.xlsx")
        ws = wb.active
        ws.title = "PED COMMENTS"

        # ---- Header ----
        ws['AB1'] = form['record_no'] or ''
        ws['AB2'] = form['record_date'] or ''
        ws['C3']  = form['customer'] or ''
        ws['F3']  = form['bid'] or ''
        ws['S3']  = form['po'] or ''
        ws['AC3'] = form['cr'] or ''
        ws['C26'] = form['amendment_details'] or ''

        # ---- Comments ----
        comments = db.execute("""
            SELECT department, username, comment_text
            FROM ped_comments
            WHERE ped_form_id = ?
            ORDER BY created_at
        """, (form_id,)).fetchall()

        start_row = 5
        for idx, c in enumerate(comments, start=1):
            r = start_row + idx - 1
            ws[f"A{r}"] = idx
            ws[f"B{r}"] = c['department']
            ws[f"C{r}"] = "PED"
            ws[f"D{r}"] = c['username']
            ws[f"E{r}"] = c['comment_text']

        buf = BytesIO()
        wb.save(buf)
        buf.seek(0)
        return buf

    # ---------------- FILES ----------------
    templates = {
        'PED_1': 'attached_assets/PED 1_1763437023609.xlsx',
        'PED_2': 'attached_assets/PED 2_1763437023609.xlsx'
    }
    logo_path = 'attached_assets/GTN_LOGO_1762400078631.png'

    for p in templates.values():
        if not os.path.exists(p):
            return jsonify({'error': f'Missing template {p}'}), 404
    if not os.path.exists(logo_path):
        logo_path = None

    ped2_remarks_map = {
        'special_process': 6,
        'welding': 11,
        'assembly_testing': 13,
        'quality_control': 15,
        'painting_despatch': 20,
        'customer_service_sales': 24,
        'commercial': 28
    }

    ped1_cycle_positions = [6,7,8,9,10,11,12,13,15,19]

    ped1_header = {
        'record_no_col': 23,
        'record_date_col': 23,
        'customer_row_col': (3,3),
        'bid_row_col': (3,5),
        'po_row_col': (3,12),
        'cr_row_col': (3,22),
        'remarks_col': 22,
        'amendment_row_col': (19,3)
    }

    ped2_header = {
        'record_no_col': 29,
        'record_date_col': 29,
        'customer_row_col': (3,3),
        'bid_row_col': (3,5),
        'po_row_col': (3,13),
        'cr_row_col': (3,27),
        'remarks_col': 29,
        'amendment_row_col': (19,3)
    }

    # ---------------- NEW: filter by selected PO IDs ----------------
    po_ids_param = (request.args.get('po_ids') or '').strip()
    po_ids = []
    if po_ids_param:
        try:
            po_ids = [int(x) for x in po_ids_param.split(',') if x.strip().isdigit()]
        except Exception:
            po_ids = []

    db = get_db()
    try:
        if po_ids:
            placeholders = ",".join("?" for _ in po_ids)
            pos_rows = db.execute(
                f"SELECT customer, bid, po, cr FROM pos WHERE id IN ({placeholders})",
                po_ids
            ).fetchall()

            po_keys = [f"{p['customer']}|{p['bid']}|{p['po']}|{p['cr']}" for p in pos_rows]
            if not po_keys:
                db.close()
                return jsonify({'error': 'No matching POs found for given po_ids'}), 404

            key_placeholders = ",".join("?" for _ in po_keys)
            forms = db.execute(f"""
                SELECT id, customer, bid, po, cr,
                       record_no, record_date, amendment_details
                FROM ped_forms
                WHERE po_key IN ({key_placeholders})
                ORDER BY id
            """, po_keys).fetchall()
        else:
            # Backward compatible: if no po_ids passed, export all (old behavior)
            forms = db.execute("""
                SELECT id, customer, bid, po, cr,
                       record_no, record_date, amendment_details
                FROM ped_forms
                ORDER BY id
            """).fetchall()

        if not forms:
            db.close()
            return jsonify({'error': 'No PED forms found for selected POs'}), 404

        zip_buffer = BytesIO()
        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
            for idx, form in enumerate(forms):
                form_id = form['id']
                safe_customer = ''.join(
                    c for c in (form['customer'] or 'Customer')
                    if c.isalnum() or c in (' ','_','-')
                )[:30]

                rows = db.execute("""
                    SELECT item_no, part_number, part_description,
                           rev, qty, ped_cycles, notes, remarks
                    FROM ped_form_rows
                    WHERE ped_form_id = ?
                    ORDER BY id
                """, (form_id,)).fetchall()

                # ================= PED_1 =================
                wb1 = openpyxl.load_workbook(templates['PED_1'])
                ws1 = wb1.active
                mm1 = build_merged_cell_map(ws1)

                if logo_path:
                    try:
                        img = Image(logo_path); img.width=80; img.height=60
                        ws1.add_image(img,'A1')
                    except: pass

                write_cell(ws1,1,ped1_header['record_no_col'],form['record_no'],mm1)
                write_cell(ws1,2,ped1_header['record_date_col'],form['record_date'],mm1)
                write_cell(ws1,*ped1_header['customer_row_col'],form['customer'],mm1)
                write_cell(ws1,*ped1_header['bid_row_col'],form['bid'],mm1)
                write_cell(ws1,*ped1_header['po_row_col'],form['po'],mm1)
                write_cell(ws1,*ped1_header['cr_row_col'],form['cr'],mm1)
                write_cell(ws1,*ped1_header['amendment_row_col'],form['amendment_details'],mm1)

                r0 = 8
                for i,row in enumerate(rows):
                    er = r0+i
                    write_cell(ws1,er,1,row['item_no'],mm1)
                    write_cell(ws1,er,2,row['part_number'],mm1)
                    write_cell(ws1,er,3,row['part_description'],mm1)
                    write_cell(ws1,er,4,row['rev'],mm1)
                    write_cell(ws1,er,5,row['qty'],mm1)

                    cycles = json.loads(row['ped_cycles']) if row['ped_cycles'] else []
                    for ci,col in enumerate(ped1_cycle_positions):
                        write_cell(ws1,er,col,cycles[ci] if ci<len(cycles) else '',mm1)

                    write_cell(ws1,er,ped1_header['remarks_col'],row['remarks'],mm1)

                b1=BytesIO(); wb1.save(b1); b1.seek(0)
                zip_file.writestr(f"PED_1_{idx+1}_{safe_customer}.xlsx",b1.read())

                # ================= PED_2 =================
                wb2 = openpyxl.load_workbook(templates['PED_2'])
                ws2 = wb2.active
                mm2 = build_merged_cell_map(ws2)

                if logo_path:
                    try:
                        img = Image(logo_path); img.width=80; img.height=60
                        ws2.add_image(img,'A1')
                    except: pass

                write_cell(ws2,1,ped2_header['record_no_col'],form['record_no'],mm2)
                write_cell(ws2,2,ped2_header['record_date_col'],form['record_date'],mm2)
                write_cell(ws2,*ped2_header['customer_row_col'],form['customer'],mm2)
                write_cell(ws2,*ped2_header['bid_row_col'],form['bid'],mm2)
                write_cell(ws2,*ped2_header['po_row_col'],form['po'],mm2)
                write_cell(ws2,*ped2_header['cr_row_col'],form['cr'],mm2)
                write_cell(ws2,*ped2_header['amendment_row_col'],form['amendment_details'],mm2)

                order = ['special_process','welding','assembly_testing','quality_control',
                         'painting_despatch','customer_service_sales','commercial']

                for i,row in enumerate(rows):
                    er = r0+i
                    write_cell(ws2,er,1,row['item_no'],mm2)
                    write_cell(ws2,er,2,row['part_number'],mm2)
                    write_cell(ws2,er,3,row['part_description'],mm2)
                    write_cell(ws2,er,4,row['rev'],mm2)
                    write_cell(ws2,er,5,row['qty'],mm2)

                    notes = json.loads(row['notes']) if row['notes'] else []
                    for ni,key in enumerate(order):
                        write_cell(ws2,er,ped2_remarks_map[key],
                                   notes[ni] if ni<len(notes) else '',mm2)

                    write_cell(ws2,er,ped2_header['remarks_col'],row['remarks'],mm2)

                b2=BytesIO(); wb2.save(b2); b2.seek(0)
                zip_file.writestr(f"PED_2_{idx+1}_{safe_customer}.xlsx",b2.read())

                # ================= PED COMMENTS (ONCE) =================
                cbuf = build_ped_comments_excel(db, form, form_id)
                zip_file.writestr(f"PED_Comments_{safe_customer}.xlsx", cbuf.read())

        db.close()
        zip_buffer.seek(0)
        resp = make_response(zip_buffer.read())
        resp.headers['Content-Type']='application/zip'
        resp.headers['Content-Disposition']='attachment; filename=PED_Export.zip'
        return resp

    except Exception as e:
        try: db.close()
        except: pass
        return jsonify({'error': str(e)}), 500

def build_lead_comments_excel(db, form, form_id):
    import openpyxl
    from io import BytesIO

    template_path = "attached_assets/Comments.xlsx"
    wb = openpyxl.load_workbook(template_path)
    ws = wb.active
    ws.title = "LEAD COMMENTS"

    # ---- Header ----
    ws['AB1'] = form['record_no'] or ''
    ws['AB2'] = form['record_date'] or ''
    ws['C3']  = form['customer'] or ''
    ws['F3']  = form['bid'] or ''
    ws['S3']  = form['po'] or ''
    ws['AC3'] = form['cr'] or ''
    ws['C26'] = form['general_remarks'] or ''

    # ---- Comments ----
    comments = db.execute("""
        SELECT department, username, comment_text
        FROM lead_comments
        WHERE lead_form_id = ?
        ORDER BY created_at
    """, (form_id,)).fetchall()

    start_row = 5
    for idx, c in enumerate(comments, start=1):
        r = start_row + idx - 1
        ws[f"A{r}"] = idx
        ws[f"B{r}"] = c['department']
        ws[f"C{r}"] = "LEAD"
        ws[f"D{r}"] = c['username']
        ws[f"E{r}"] = c['comment_text']

    buffer = BytesIO()
    wb.save(buffer)
    buffer.seek(0)
    return buffer

@app.route('/api/lead-export-excel', methods=['GET'])
@login_required
def export_lead_to_excel():
    import openpyxl
    from openpyxl.drawing.image import Image
    from io import BytesIO
    import zipfile
    from flask import make_response, jsonify, request
    import os

    def build_merged_cell_map(ws):
        merged_map = {}
        for mr in ws.merged_cells.ranges:
            r0, c0 = mr.min_row, mr.min_col
            for r in range(mr.min_row, mr.max_row + 1):
                for c in range(mr.min_col, mr.max_col + 1):
                    merged_map[(r, c)] = (r0, c0)
        return merged_map

    def write_cell(ws, row, col, value, merged_map):
        if (row, col) in merged_map:
            ar, ac = merged_map[(row, col)]
            ws.cell(row=ar, column=ac).value = value
        else:
            ws.cell(row=row, column=col).value = value

    template_path = 'attached_assets/Lead Form_1763437805952.xlsx'
    logo_path = 'attached_assets/GTN_LOGO_1762400078631.png'

    if not os.path.exists(template_path):
        return jsonify({'error': 'Lead Form template file not found'}), 404

    use_logo = os.path.exists(logo_path)

    # ---------------- NEW: filter by selected PO IDs ----------------
    po_ids_param = (request.args.get('po_ids') or '').strip()
    po_ids = []
    if po_ids_param:
        try:
            po_ids = [int(x) for x in po_ids_param.split(',') if x.strip().isdigit()]
        except Exception:
            po_ids = []

    db = get_db()
    try:
        if po_ids:
            # Map selected pos.id -> po_key (customer|bid|po|cr) and filter lead_forms by po_key
            placeholders = ",".join("?" for _ in po_ids)
            pos_rows = db.execute(
                f"SELECT customer, bid, po, cr FROM pos WHERE id IN ({placeholders})",
                po_ids
            ).fetchall()

            po_keys = [f"{p['customer']}|{p['bid']}|{p['po']}|{p['cr']}" for p in pos_rows]
            if not po_keys:
                db.close()
                return jsonify({'error': 'No matching POs found for given po_ids'}), 404

            key_placeholders = ",".join("?" for _ in po_keys)
            forms = db.execute(f"""
                SELECT id, customer, bid, po, cr,
                       record_no, record_date, general_remarks
                FROM lead_forms
                WHERE po_key IN ({key_placeholders})
                ORDER BY id
            """, po_keys).fetchall()
        else:
            # Backward compatible: if no po_ids passed, export all (old behavior)
            forms = db.execute("""
                SELECT id, customer, bid, po, cr,
                       record_no, record_date, general_remarks
                FROM lead_forms
                ORDER BY id
            """).fetchall()

        if not forms:
            db.close()
            return jsonify({'error': 'No Lead forms found for selected POs'}), 404

        zip_buffer = BytesIO()
        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
            for idx, form in enumerate(forms):
                form_id = form['id']
                safe_customer = ''.join(
                    c for c in (form['customer'] or 'Customer')
                    if c.isalnum() or c in (' ','_','-')
                )[:30]

                wb = openpyxl.load_workbook(template_path)
                ws = wb.active
                merged_map = build_merged_cell_map(ws)

                if use_logo:
                    try:
                        img = Image(logo_path)
                        img.width = 80
                        img.height = 60
                        ws.add_image(img, 'A1')
                    except Exception:
                        pass

                # ---- Header ----
                write_cell(ws, 1, 16, form['record_no'] or 'SAL/R02/Y', merged_map)  # P1
                write_cell(ws, 2, 16, form['record_date'] or '', merged_map)        # P2
                write_cell(ws, 3, 3, form['customer'] or '', merged_map)            # C3
                write_cell(ws, 3, 6, form['bid'] or '', merged_map)                 # F3
                write_cell(ws, 3, 11, form['po'] or '', merged_map)                 # K3
                write_cell(ws, 3, 16, form['cr'] or '', merged_map)                 # P3

                # ---- Amendment / General Remarks ----
                write_cell(ws, 17, 1, form['general_remarks'] or '', merged_map)

                # ---- Rows ----
                rows = db.execute("""
                    SELECT item_no, part_number, part_description,
                           rev, qty, customer_required_date,
                           standard_lead_time, gtn_agreed_date, remarks
                    FROM lead_form_rows
                    WHERE lead_form_id = ?
                    ORDER BY id
                """, (form_id,)).fetchall()

                start_row = 6
                for i, r in enumerate(rows):
                    er = start_row + i
                    write_cell(ws, er, 1, r['item_no'], merged_map)
                    write_cell(ws, er, 2, r['part_number'], merged_map)
                    write_cell(ws, er, 4, r['part_description'], merged_map)
                    write_cell(ws, er, 10, r['rev'], merged_map)
                    write_cell(ws, er, 11, r['qty'], merged_map)
                    write_cell(ws, er, 12, r['customer_required_date'], merged_map)
                    write_cell(ws, er, 14, r['standard_lead_time'], merged_map)
                    write_cell(ws, er, 15, r['gtn_agreed_date'], merged_map)
                    write_cell(ws, er, 16, r['remarks'], merged_map)

                buf = BytesIO()
                wb.save(buf)
                buf.seek(0)
                zip_file.writestr(f"Lead_Form_{idx+1}_{safe_customer}.xlsx", buf.read())

                #  LEAD COMMENTS (ONCE)
                comments_buf = build_lead_comments_excel(db, form, form_id)
                zip_file.writestr(
                    f"Lead_Comments_{safe_customer}.xlsx",
                    comments_buf.read()
                )

        db.close()
        zip_buffer.seek(0)
        response = make_response(zip_buffer.read())
        response.headers['Content-Type'] = 'application/zip'
        response.headers['Content-Disposition'] = 'attachment; filename=Lead_Export.zip'
        return response

    except Exception as e:
        try:
            db.close()
        except:
            pass
        return jsonify({'error': str(e)}), 500

# ---------- CR COMMENTS ----------

@app.route('/api/cr-comments/<int:form_id>', methods=['POST'])
@login_required
def post_cr_comment(form_id):
  data = request.get_json()
  comment_text = data.get('comment', '').strip()

  if not comment_text:
    return jsonify({'error': 'Comment text is required'}), 400

  username = session.get('username', 'unknown')
  department = session.get('user_department', 'unknown')

  db = get_db()
  try:
    db.execute('''
            INSERT INTO cr_comments (cr_form_id, username, department, comment_text)
            VALUES (?, ?, ?, ?)
        ''', (form_id, username, department, comment_text))
    db.commit()

    comment_id = db.execute('SELECT last_insert_rowid() as id').fetchone()['id']
    created_at = db.execute(
      'SELECT created_at FROM cr_comments WHERE id = ?',
      (comment_id, )).fetchone()['created_at']

    db.close()

    return jsonify({
      'success': True,
      'comment': {
        'id': comment_id,
        'username': username,
        'department': department,
        'text': comment_text,
        'createdAt': created_at
      }
    })
  except Exception as e:
    db.close()
    return jsonify({'error': str(e)}), 500

@app.route('/api/cr-comments/<int:form_id>', methods=['GET'])
@login_required
def get_cr_comments(form_id):
  db = get_db()
  try:
    comments = db.execute('''
            SELECT id, username, department, comment_text, created_at
            FROM cr_comments
            WHERE cr_form_id = ?
            ORDER BY created_at ASC
        ''', (form_id, )).fetchall()

    db.close()

    return jsonify({
      'comments': [{
        'id': c['id'],
        'username': c['username'],
        'department': c['department'],
        'text': c['comment_text'],
        'createdAt': c['created_at']
      } for c in comments]
    })
  except Exception as e:
    db.close()
    return jsonify({'error': str(e)}), 500

@app.route('/api/ped-comments/<int:form_id>', methods=['GET'])
@login_required
def get_ped_comments(form_id):
    db = get_db()
    try:
        comments = db.execute('''
                SELECT id, username, department, comment_text, created_at
                FROM ped_comments
                WHERE ped_form_id = ?
                ORDER BY created_at ASC
            ''', (form_id, )).fetchall()

        db.close()

        return jsonify({
            'comments': [{
                'id': c['id'],
                'username': c['username'],
                'department': c['department'],
                'text': c['comment_text'],
                'createdAt': c['created_at']
            } for c in comments]
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/ped-comments/<int:form_id>', methods=['POST'])
@login_required
def post_ped_comment(form_id):
    data = request.get_json()
    comment_text = data.get('comment', '').strip()

    if not comment_text:
        return jsonify({'error': 'Comment text is required'}), 400

    username = session.get('username', 'unknown')
    department = session.get('user_department', 'unknown')

    db = get_db()
    try:
        db.execute('''
                INSERT INTO ped_comments (ped_form_id, username, department, comment_text)
                VALUES (?, ?, ?, ?)
            ''', (form_id, username, department, comment_text))
        db.commit()

        comment_id = db.execute(
            'SELECT last_insert_rowid() as id'
        ).fetchone()['id']
        created_at = db.execute(
            'SELECT created_at FROM ped_comments WHERE id = ?',
            (comment_id, )
        ).fetchone()['created_at']

        db.close()

        return jsonify({
            'success': True,
            'comment': {
                'id': comment_id,
                'username': username,
                'department': department,
                'text': comment_text,
                'createdAt': created_at
            }
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/lead-comments/<int:form_id>', methods=['GET'])
@login_required
def get_lead_comments(form_id):
    db = get_db()
    try:
        comments = db.execute('''
                SELECT id, username, department, comment_text, created_at
                FROM lead_comments
                WHERE lead_form_id = ?
                ORDER BY created_at ASC
            ''', (form_id, )).fetchall()

        db.close()

        return jsonify({
            'comments': [{
                'id': c['id'],
                'username': c['username'],
                'department': c['department'],
                'text': c['comment_text'],
                'createdAt': c['created_at']
            } for c in comments]
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

@app.route('/api/lead-comments/<int:form_id>', methods=['POST'])
@login_required
def post_lead_comment(form_id):
    data = request.get_json()
    comment_text = data.get('comment', '').strip()

    if not comment_text:
        return jsonify({'error': 'Comment text is required'}), 400

    username = session.get('username', 'unknown')
    department = session.get('user_department', 'unknown')

    db = get_db()
    try:
        db.execute('''
                INSERT INTO lead_comments (lead_form_id, username, department, comment_text)
                VALUES (?, ?, ?, ?)
            ''', (form_id, username, department, comment_text))
        db.commit()

        comment_id = db.execute(
            'SELECT last_insert_rowid() as id'
        ).fetchone()['id']
        created_at = db.execute(
            'SELECT created_at FROM lead_comments WHERE id = ?',
            (comment_id, )
        ).fetchone()['created_at']

        db.close()

        return jsonify({
            'success': True,
            'comment': {
                'id': comment_id,
                'username': username,
                'department': department,
                'text': comment_text,
                'createdAt': created_at
            }
        })
    except Exception as e:
        db.close()
        return jsonify({'error': str(e)}), 500

# ---------- Notifications ----------

@app.route('/api/notifications', methods=['GET'])
@login_required
def get_notifications():
  user_id = session.get('user_id')
  limit = request.args.get('limit', 50, type=int)

  db = get_db()
  try:
    notifications = db.execute('''
            SELECT n.*, u.username as actor_username
            FROM notifications n
            LEFT JOIN users u ON n.actor_user_id = u.id
            WHERE n.recipient_user_id = ?
            ORDER BY n.created_at DESC
            LIMIT ?
        ''', (user_id, limit)).fetchall()

    unread_count = db.execute('''
            SELECT COUNT(*) as count FROM notifications 
            WHERE recipient_user_id = ? AND is_read = 0
        ''', (user_id, )).fetchone()['count']

    db.close()

    return jsonify({
      'notifications': [{
        'id': n['id'],
        'eventType': n['event_type'],
        'message': n['message'],
        'isRead': bool(n['is_read']),
        'createdAt': n['created_at'],
        'actorUsername': n['actor_username']
      } for n in notifications],
      'unreadCount': unread_count
    })
  except Exception as e:
    db.close()
    return jsonify({'error': str(e)}), 500

@app.route('/api/notifications/unread_count', methods=['GET'])
@login_required
def get_unread_count():
  user_id = session.get('user_id')

  db = get_db()
  try:
    unread_count = db.execute('''
            SELECT COUNT(*) as count FROM notifications 
            WHERE recipient_user_id = ? AND is_read = 0
        ''', (user_id, )).fetchone()['count']

    db.close()

    return jsonify({'unreadCount': unread_count})
  except Exception as e:
    db.close()
    return jsonify({'error': str(e)}), 500

@app.route('/api/notifications/<int:notification_id>/read', methods=['PUT'])
@login_required
def mark_notification_read(notification_id):
  user_id = session.get('user_id')

  db = get_db()
  try:
    db.execute('''
            UPDATE notifications 
            SET is_read = 1 
            WHERE id = ? AND recipient_user_id = ?
        ''', (notification_id, user_id))
    db.commit()
    db.close()

    return jsonify({'success': True})
  except Exception as e:
    db.close()
    return jsonify({'error': str(e)}), 500

@app.route('/api/notifications/mark_all_read', methods=['PUT'])
@login_required
def mark_all_read():
  user_id = session.get('user_id')

  db = get_db()
  try:
    db.execute('''
            UPDATE notifications 
            SET is_read = 1 
            WHERE recipient_user_id = ? AND is_read = 0
        ''', (user_id, ))
    db.commit()
    db.close()

    return jsonify({'success': True})
  except Exception as e:
    db.close()
    return jsonify({'error': str(e)}), 500

# ---------- Email config ----------

@app.route('/api/email-config', methods=['GET'])
@login_required
def get_email_config():
  if not session.get('user_is_admin'):
    return jsonify({'error': 'Admin access required'}), 403

  db = get_db()
  try:
    config = db.execute(
      'SELECT * FROM email_config ORDER BY id DESC LIMIT 1').fetchone()
    db.close()

    if config:
      return jsonify({
        'smtp_host': config['smtp_host'],
        'smtp_port': config['smtp_port'],
        'smtp_username': config['smtp_username'],
        'from_email': config['from_email'],
        'use_tls': bool(config['use_tls']),
        'email_enabled': bool(config['email_enabled']),
        'has_password': bool(config['smtp_password'])
      })
    else:
      return jsonify({
        'smtp_host': '',
        'smtp_port': 587,
        'smtp_username': '',
        'from_email': '',
        'use_tls': True,
        'email_enabled': False,
        'has_password': False
      })
  except Exception as e:
    db.close()
    return jsonify({'error': str(e)}), 500

@app.route('/api/email-config', methods=['POST'])
@login_required
def save_email_config():
  if not session.get('user_is_admin'):
    return jsonify({'error': 'Admin access required'}), 403

  data = request.json
  username = session.get('username')

  db = get_db()
  try:
    existing = db.execute(
      'SELECT id, smtp_password FROM email_config ORDER BY id DESC LIMIT 1'
    ).fetchone()

    smtp_password = data.get('smtp_password', '')
    if not smtp_password and existing:
      smtp_password = existing['smtp_password']
    elif smtp_password:
      smtp_password = encrypt_password(smtp_password)

    if not smtp_password:
      return jsonify({'error': 'SMTP password is required'}), 400

    if existing:
      db.execute('''
                UPDATE email_config SET 
                    smtp_host = ?,
                    smtp_port = ?,
                    smtp_username = ?,
                    smtp_password = ?,
                    from_email = ?,
                    use_tls = ?,
                    email_enabled = ?,
                    updated_by = ?,
                    updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            ''', (data.get('smtp_host'), data.get('smtp_port', 587),
                  data.get('smtp_username'), smtp_password,
                  data.get('from_email'),
                  1 if data.get('use_tls', True) else 0,
                  1 if data.get('email_enabled', False) else 0, username,
                  existing['id']))
    else:
      db.execute('''
                INSERT INTO email_config 
                (smtp_host, smtp_port, smtp_username, smtp_password, from_email, use_tls, email_enabled, updated_by)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (data.get('smtp_host'), data.get('smtp_port', 587),
                  data.get('smtp_username'), smtp_password,
                  data.get('from_email'),
                  1 if data.get('use_tls', True) else 0,
                  1 if data.get('email_enabled', False) else 0, username))

    db.commit()
    db.close()

    return jsonify(
      {'success': True, 'message': 'Email configuration saved successfully'})
  except Exception as e:
    db.close()
    return jsonify({'error': str(e)}), 500

@app.route('/api/email-config/test', methods=['POST'])
@login_required
def test_email_config():
  if not session.get('user_is_admin'):
    return jsonify({'error': 'Admin access required'}), 403

  import smtplib
  from email.mime.text import MIMEText
  from email.mime.multipart import MIMEMultipart

  data = request.json
  test_email = data.get('test_email')

  if not test_email:
    return jsonify({'error': 'Test email address is required'}), 400

  db = get_db()
  try:
    config = db.execute(
      'SELECT * FROM email_config ORDER BY id DESC LIMIT 1').fetchone()
    db.close()

    if not config:
      return jsonify({
        'error':
        'No email configuration found. Please save configuration first.'
      }), 400

    msg = MIMEMultipart()
    msg['From'] = config['from_email']
    msg['To'] = test_email
    msg['Subject'] = 'GTN Engineering - Email Configuration Test'

    body = '''
        <html>
        <body>
            <h2>Email Configuration Test</h2>
            <p>This is a test email from GTN Engineering Contract Review Dashboard.</p>
            <p>If you received this email, your SMTP configuration is working correctly!</p>
            <p><strong>Configuration Details:</strong></p>
            <ul>
                <li>SMTP Host: {}</li>
                <li>SMTP Port: {}</li>
                <li>From Email: {}</li>
            </ul>
        </body>
        </html>
        '''.format(config['smtp_host'], config['smtp_port'],
                   config['from_email'])

    msg.attach(MIMEText(body, 'html'))

    decrypted_password = decrypt_password(config['smtp_password'])

    server = smtplib.SMTP(config['smtp_host'], config['smtp_port'])
    if config['use_tls']:
      server.starttls()
    server.login(config['smtp_username'], decrypted_password)
    server.send_message(msg)
    server.quit()

    return jsonify({
      'success': True,
      'message': f'Test email sent successfully to {test_email}'
    })
  except Exception as e:
    return jsonify(
      {'error': f'Failed to send test email: {str(e)}'}), 500

@app.route('/attached_assets/<path:filename>')
def attached_assets(filename):
  return send_from_directory('attached_assets', filename)

if __name__ == '__main__':
    init_db()
    app.run(host='0.0.0.0', port=1000, debug=True)